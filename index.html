<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Before You Go - AI Travel Planner</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Lexend:wght@600;700;800&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- For parsing Gemini's Markdown responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // This is the one file we need, so we'll import everything we need in the main script
    </script>

    <!-- Brand Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-primary': '#14B8A6',
                        'brand-primary-dark': '#0F766E',
                        'brand-primary-light': '#A7F3D0',
                        'brand-accent': '#F97316',
                        'brand-accent-hover': '#EA580C',
                        'brand-dark': '#1F2937',
                        'brand-light': '#F9FAFB',
                    },
                    fontFamily: {
                        'heading': ['Lexend', 'sans-serif'],
                        'sans': ['Inter', 'sans-serif'],
                    },
                    borderRadius: { '4xl': '2rem' },
                    keyframes: {
                        fadeInUp: {
                          '0%': { opacity: '0', transform: 'translateY(20px)' },
                          '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        fadeOutDown: {
                          '0%': { opacity: '1', transform: 'translateY(0)' },
                          '100%': { opacity: '0', transform: 'translateY(20px)' },
                        }
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                        'fade-out-down': 'fadeOutDown 0.5s ease-out forwards'
                    }
                }
            }
        }
    </script>
    <!-- Custom Styles -->
    <style>
        .gradient-text { background: linear-gradient(to right, #14B8A6, #F97316); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn-gradient { background: linear-gradient(to right, #F97316, #EA580C); transition: all 0.5s; background-size: 200% auto; }
        .btn-gradient:hover { background-position: right center; }
        .hero-background { background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.4)), url('https://images.pexels.com/photos/3278215/pexels-photo-3278215.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2'); background-size: cover; background-position: center; }
        .overlap-section { margin-top: -80px; }
        .textured-section { background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23F3F4F6' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); }
        .card-hover { transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; }
        .card-hover:hover { transform: translateY(-8px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }
        .modal { display: none; }
        .modal.is-open { display: flex; }
        .modal-content { animation: fadeInUp 0.5s ease-out forwards; }
        .prose h2, .gemini-content h2 { margin-top: 2em; margin-bottom: 1em; font-family: 'Lexend', sans-serif; font-weight: 700; color: #1F2937; }
        .prose h3, .gemini-content h3 { margin-top: 1.5em; margin-bottom: 0.5em; font-family: 'Lexend', sans-serif; font-weight: 600; color: #1F2937; font-size: 1.25rem;}
        .prose p, .prose li, .gemini-content p, .gemini-content li { color: #4B5563; line-height: 1.75; }
        .prose a, .gemini-content a { color: #14B8A6; }
        .gemini-content ul { list-style-type: disc; list-style-position: inside; }
        .gemini-content ol { list-style-type: decimal; list-style-position: inside; }
        .itinerary-day { border-left: 3px solid #14B8A6; padding-left: 1.5rem; margin-top: 1.5rem; }
        .trip-details { max-height: 0; overflow: hidden; transition: max-height 0.7s ease-in-out; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 24px; height: 24px; border-radius: 50%; border-left-color: #14B8A6; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Styling for generated markdown content */
        .gemini-content h3 { font-family: 'Lexend', sans-serif; font-size: 1.25rem; font-weight: 600; color: #1F2937; margin-top: 1.5em; }
        .gemini-content p { color: #4B5563; }
        .gemini-content ul { list-style-position: inside; }
        .gemini-content li { margin-bottom: 0.5em; }
        /* New class to make proxy modal appear on top */
        .z-60 { z-index: 60; }
        /* Hide scrollbar for chat window, but keep scrollable */
        #ai-buddy-chat-window::-webkit-scrollbar,
        #my-itinerary-content::-webkit-scrollbar { display: none; }
        #ai-buddy-chat-window,
        #my-itinerary-content { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-brand-light text-brand-dark font-sans">
    
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-sm shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#" class="text-2xl font-heading font-bold text-brand-primary flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                Before You Go
            </a>
            <nav class="hidden md:flex items-center space-x-6 font-medium">
                <a href="#features" class="text-gray-600 hover:text-brand-primary transition duration-300">Features</a>
                <a href="#how-it-works" class="text-gray-600 hover:text-brand-primary transition duration-300">Process</a>
                <a href="#inspiration" class="text-gray-600 hover:text-brand-primary transition duration-300">Inspiration</a>
                
                <!-- "My Itinerary" Button -->
                <button id="my-itinerary-btn" data-modal-trigger="my-itinerary-modal" class="hidden text-brand-primary font-semibold px-4 py-2 rounded-full hover:bg-brand-primary-light transition-all duration-300">
                    My Itinerary
                </button>

                <!-- Auth Status Container -->
                <div id="auth-status" class="flex items-center">
                    <div id="auth-loading" class="w-6 h-6 rounded-full animate-spin border-4 border-dashed border-brand-primary border-t-transparent"></div>
                    <button id="auth-signin-btn" data-modal-trigger="auth-modal" class="hidden bg-brand-primary text-white px-5 py-2 rounded-full font-semibold hover:bg-brand-primary-dark transition-all duration-300">
                        Sign In
                    </button>
                    <div id="auth-user-info" class="hidden flex items-center gap-4">
                        <span id="auth-user-id" class="text-sm text-gray-600 font-medium"></span>
                        <button id="auth-signout-btn" class="text-sm text-gray-500 hover:text-brand-accent font-semibold">Sign Out</button>
                    </div>
                </div>
                
                <button data-modal-trigger="quiz-modal" class="bg-brand-accent text-white px-6 py-2.5 rounded-full font-semibold hover:bg-brand-accent-hover transition-all duration-300 shadow-md transform hover:scale-105">Find Your Trip</button>
            </nav>
            <button id="mobile-menu-btn" class="md:hidden text-gray-600"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg></button>
        </div>
        <div id="mobile-menu" class="hidden md:hidden px-6 pb-4">
             <a href="#features" class="block py-2 text-gray-600 hover:text-brand-primary">Features</a>
             <a href="#how-it-works" class="block py-2 text-gray-600 hover:text-brand-primary">Process</a>
             <a href="#inspiration" class="block py-2 text-gray-600 hover:text-brand-primary">Inspiration</a>
             
             <!-- Mobile "My Itinerary" Button -->
             <button id="my-itinerary-btn-mobile" data-modal-trigger="my-itinerary-modal" class="hidden w-full text-center mt-2 text-brand-primary font-semibold px-4 py-2 rounded-full hover:bg-brand-primary-light">
                My Itinerary
             </button>

             <!-- Mobile Auth Buttons -->
             <button id="auth-signin-btn-mobile" data-modal-trigger="auth-modal" class="hidden w-full text-center mt-2 bg-brand-primary text-white px-4 py-2 rounded-full font-semibold">
                Sign In
             </button>
             <div id="auth-user-info-mobile" class="hidden mt-2 text-center">
                <span id="auth-user-id-mobile" class="text-sm text-gray-600 font-medium"></span>
                <button id="auth-signout-btn-mobile" class="block w-full text-center mt-2 text-gray-500 hover:text-brand-accent font-semibold">Sign Out</button>
             </div>

             <button data-modal-trigger="quiz-modal" class="block w-full text-center mt-2 bg-brand-accent text-white px-4 py-2 rounded-full font-semibold hover:bg-brand-accent-hover">Find Your Trip</button>
        </div>
    </header>

    <main>
        <!-- Sections of the landing page -->
        <section class="hero-background text-white min-h-[60vh] flex items-center">
            <div class="container mx-auto px-6 text-center">
                <h1 class="font-heading text-4xl md:text-6xl font-extrabold leading-tight mb-4">Your Journey, Perfectly Imagined.</h1>
                <p class="text-lg md:text-xl text-gray-200 max-w-3xl mx-auto mb-8">Unleash your inner explorer. We use AI to translate your personality into unforgettable travel experiences.</p>
                <div>
                    <button data-modal-trigger="quiz-modal" class="btn-gradient text-white px-8 py-4 rounded-full text-lg font-bold transition-all duration-500 shadow-lg transform hover:scale-105">Discover Your Travel DNA</button>
                </div>
            </div>
        </section>

        <!-- How it Works Section -->
        <section id="how-it-works" class="py-24 overlap-section">
            <div class="container mx-auto px-6">
                <div class="bg-white shadow-xl rounded-4xl p-8 md:p-16">
                    <div class="text-center mb-16">
                        <h2 class="font-heading text-4xl font-bold text-brand-dark">Crafting Your <span class="gradient-text">Unforgettable Journey</span></h2>
                        <p class="text-lg text-gray-600 mt-4">A simple, inspiring process to design the trip of your dreams.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                       <!-- Step 1 -->
                        <button data-modal-trigger="quiz-modal" class="group flex flex-col items-center card-hover bg-gray-50 p-8 rounded-3xl text-left">
                            <div class="h-20 w-20 flex items-center justify-center mb-6"><svg class="h-16 w-16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" stroke="#14B8A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 14h.01M12 18h.01M16 14h.01M16 18h.01" stroke="#F97316" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                            <h3 class="font-heading text-2xl font-semibold text-brand-dark mb-3">1. Reveal Your Persona</h3>
                            <p class="text-gray-600">Our psychology-backed quiz translates your unique traits into a clear Travel DNA profile.</p>
                        </button>
                        <!-- Step 2 -->
                        <button data-modal-trigger="explore-modal" class="group flex flex-col items-center card-hover bg-gray-50 p-8 rounded-3xl text-left">
                            <div class="h-20 w-20 flex items-center justify-center mb-6"><svg class="h-16 w-16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" stroke="#14B8A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="11" r="3" stroke="#F97316" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                            <h3 class="font-heading text-2xl font-semibold text-brand-dark mb-3">2. Explore Possibilities</h3>
                            <p class="text-gray-600">Our AI predicts destinations you'll love, uncovering hidden gems and authentic experiences.</p>
                        </button>
                        <!-- Step 3 -->
                        <button data-modal-trigger="journey-modal" class="group flex flex-col items-center card-hover bg-gray-50 p-8 rounded-3xl text-left">
                            <div class="h-20 w-20 flex items-center justify-center mb-6"><svg class="h-16 w-16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 18h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" stroke="#14B8A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="8" r="1" fill="#F97316"/></svg></div>
                            <h3 class="font-heading text-2xl font-semibold text-brand-dark mb-3">3. Journey Seamlessly</h3>
                            <p class="text-gray-600">Your AI buddy has your itinerary and is ready to guide you. Ask it anything!</p>
                        </button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Other sections like Features, Inspiration, CTA -->
        <section id="features" class="py-24 bg-white">
            <div class="container mx-auto px-6">
                <div class="text-center mb-16">
                    <h2 class="font-heading text-4xl font-bold text-brand-dark">A Smarter Way to <span class="gradient-text">Explore</span></h2>
                    <p class="text-lg text-gray-600 mt-4">Every detail, personalized for you.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                     <!-- Feature Cards -->
                    <div class="bg-brand-light p-8 rounded-2xl card-hover">
                        <h3 class="font-heading text-xl font-bold text-brand-dark mb-2">AI Predictive Recommendations</h3>
                        <p class="text-gray-600">Our engine analyzes your Travel DNA to suggest destinations you’re statistically destined to love.</p>
                    </div>
                    <div class="bg-brand-light p-8 rounded-2xl card-hover">
                        <h3 class="font-heading text-xl font-bold text-brand-dark mb-2">Firestore Data Persistence</h3>
                        <p class="text-gray-600">Sign in to save your persona and itineraries, and pick up right where you left off, anytime.</p>
                    </div>
                    <div class="bg-brand-light p-8 rounded-2xl card-hover">
                        <h3 class="font-heading text-xl font-bold text-brand-dark mb-2">Social Sync Planning</h3>
                        <p class="text-gray-600">Plan group trips without the headache. Our AI merges multiple personalities into one perfect plan.</p>
                    </div>
                    <div class="bg-brand-light p-8 rounded-2xl card-hover">
                        <h3 class="font-heading text-xl font-bold text-brand-dark mb-2">Hidden Gems Engine ✨</h3>
                        <p class="text-gray-600">Discover authentic, lesser-known experiences and explore destinations like a local.</p>
                    </div>
                    <div class="bg-brand-light p-8 rounded-2xl card-hover">
                        <h3 class="font-heading text-xl font-bold text-brand-dark mb-2">Dynamic Live Itinerary ✨</h3>
                        <p class="text-gray-600">Your plans adapt in real-time to weather, delays, or spontaneous opportunities nearby.</p>
                    </div>
                    <div class="bg-brand-light p-8 rounded-2xl card-hover">
                        <h3 class="font-heading text-xl font-bold text-brand-dark mb-2">AI Travel Buddy ✨</h3>
                        <p class="text-gray-600">A conversational assistant that knows your itinerary and provides tips, translations, and guidance.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="inspiration" class="py-24 textured-section">
            <div class="container mx-auto px-6">
                 <div class="text-center mb-16">
                    <h2 class="font-heading text-4xl font-bold text-gray-800">Find Your <span class="gradient-text">Inspiration</span></h2>
                    <p id="inspiration-subtitle" class="text-lg text-gray-600 mt-4">First, take the quiz to reveal your travel persona and unlock personalized suggestions!</p>
                </div>
                <div id="inspiration-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Default State: A mix of personas -->
                    <div class="relative rounded-2xl shadow-lg overflow-hidden h-96 group card-hover">
                        <img src="https://images.pexels.com/photos/1562/italian-landscape-mountains-nature.jpg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" alt="Mountain landscape for explorers">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent flex items-end p-6">
                            <h3 class="text-white text-2xl font-heading font-bold">The Explorer</h3>
                        </div>
                    </div>
                    <div class="relative rounded-2xl shadow-lg overflow-hidden h-96 group card-hover">
                        <img src="https://images.pexels.com/photos/1450360/pexels-photo-1450360.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" alt="Serene beach for soul seekers">
                         <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent flex items-end p-6">
                            <h3 class="text-white text-2xl font-heading font-bold">The Soul Seeker</h3>
                        </div>
                    </div>
                    <div class="relative rounded-2xl shadow-lg overflow-hidden h-96 group card-hover">
                        <img src="https://images.pexels.com/photos/210307/pexels-photo-210307.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" alt="Cultural market for story collectors">
                         <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent flex items-end p-6">
                            <h3 class="text-white text-2xl font-heading font-bold">The Story Collector</h3>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="bg-brand-dark">
            <div class="container mx-auto px-6 py-20 text-center">
                <h2 class="font-heading text-4xl font-bold text-white mb-4">Ready for a New Way to Travel?</h2>
                <p class="text-gray-300 max-w-2xl mx-auto mb-8">Let's build a journey that feels like it was made just for you. Because it was.</p>
                <div>
                    <button data-modal-trigger="quiz-modal" class="btn-gradient text-white px-8 py-4 rounded-full text-lg font-bold transition-all duration-500 shadow-lg transform hover:scale-105">Get Started For Free</button>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer id="about" class="bg-gray-800 text-white">
        <div class="container mx-auto px-6 py-12">
            <div class="grid md:grid-cols-3 gap-8 text-center md:text-left">
                <!-- Footer content with links for modals -->
                <div>
                    <h3 class="font-heading text-lg font-bold">Before You Go</h3>
                    <p class="text-gray-400 mt-2">AI-Powered Travel, Personalized for You.</p>
                </div>
                <div>
                    <h3 class="font-heading text-lg font-bold">Links</h3>
                    <ul class="mt-2 space-y-2">
                        <li><a href="#features" class="text-gray-400 hover:text-white">Features</a></li>
                        <li><a href="#how-it-works" class="text-gray-400 hover:text-white">Process</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-heading text-lg font-bold">Legal</h3>
                    <ul class="mt-2 space-y-2">
                        <li><button data-modal-trigger="privacy-modal" class="text-gray-400 hover:text-white">Privacy Policy</button></li>
                        <li><button data-modal-trigger="terms-modal" class="text-gray-400 hover:text-white">Terms of Service</button></li>
                    </ul>
                </div>
            </div>
            <div class="text-center text-gray-400 mt-12 border-t border-gray-700 pt-8">
                <p>&copy; 2025 Before You Go. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Modals (Initially Hidden) -->

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white p-8 md:p-12 rounded-4xl shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto relative">
            <button class="modal-close absolute top-4 right-4 text-gray-500 hover:text-black text-2xl">&times;</button>
            <div class="text-center">
                <h2 class="font-heading text-3xl font-bold text-brand-dark">Welcome Back!</h2>
                <p class="text-gray-600 mt-2">Sign in or create an account to save your travel plans.</p>
            </div>
            <form id="auth-form" class="mt-8 space-y-4">
                <div>
                    <label for="auth-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="auth-email" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:border-brand-primary focus:ring-brand-primary">
                </div>
                <div>
                    <label for="auth-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="auth-password" required minlength="6" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:border-brand-primary focus:ring-brand-primary">
                </div>
                <p id="auth-error-message" class="text-sm text-red-600 hidden"></p>
                <div class="flex flex-col sm:flex-row gap-4 pt-4">
                    <button type="submit" id="auth-login-btn" class="w-full btn-gradient text-white px-6 py-3 rounded-full font-bold transition-all duration-500">
                        Login
                    </button>
                    <button type="submit" id="auth-signup-btn" class="w-full bg-brand-primary text-white px-6 py-3 rounded-full font-bold hover:bg-brand-primary-dark transition-all duration-300">
                        Sign Up
                    </button>
                </div>
            </form>
        </div>
    </div>


    <div id="quiz-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50 animate-fade-in-up">
        <div class="modal-content bg-white p-8 md:p-12 rounded-4xl shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <!-- Modal Content (Quiz) will be injected here by JavaScript -->
        </div>
    </div>
    <div id="explore-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white p-8 md:p-12 rounded-4xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto relative">
            <button class="modal-close absolute top-4 right-4 text-gray-500 hover:text-black text-2xl">&times;</button>
            <div class="prose max-w-none">
                <h2 class="font-heading text-3xl font-bold text-brand-dark text-center">How Our AI Finds Your Perfect Trip</h2>
                <p class="text-center text-lg">After creating your Travel DNA, our AI sifts through thousands of destinations, reviews, and hidden gems to find experiences that match your unique profile. Here's a glimpse of what you might see:</p>
                <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6 not-prose">
                    <div class="border rounded-2xl p-4 text-center">
                        <img src="https://images.pexels.com/photos/1684151/pexels-photo-1684151.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2" class="rounded-xl aspect-square object-cover" alt="Adventure destination">
                        <h3 class="font-heading text-xl font-bold mt-4">For The Thrill-Chaser</h3>
                        <p class="text-sm">We've found a 98% match with whitewater rafting in Costa Rica.</p>
                    </div>
                    <div class="border rounded-2xl p-4 text-center">
                        <img src="https://images.pexels.com/photos/210307/pexels-photo-210307.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2" class="rounded-xl aspect-square object-cover" alt="Cultural destination">
                        <h3 class="font-heading text-xl font-bold mt-4">For The Story-Collector</h3>
                        <p class="text-sm">You'd love exploring the ancient markets of Marrakesh.</p>
                    </div>
                    <div class="border rounded-2xl p-4 text-center">
                        <img src="https://images.pexels.com/photos/1450360/pexels-photo-1450360.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2" class="rounded-xl aspect-square object-cover" alt="Relaxing destination">
                        <h3 class="font-heading text-xl font-bold mt-4">For The Soul-Seeker</h3>
                        <p class="text-sm">A 95% match for a wellness retreat in the Swiss Alps.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="journey-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white p-8 md:p-12 rounded-4xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto relative flex flex-col">
            <button class="modal-close absolute top-4 right-4 text-gray-500 hover:text-black text-2xl">&times;</button>
             <div class="prose max-w-none text-center mb-4">
                <h2 class="font-heading text-3xl font-bold text-brand-dark flex items-center justify-center gap-3">AI Travel Buddy <span class="text-4xl">✨</span></h2>
                <p>I have your new itinerary. Ask me for packing tips, local customs, or details about your trip!</p>
            </div>
            <div id="ai-buddy-chat-window" class="h-[400px] border rounded-2xl p-4 overflow-y-auto bg-gray-50 flex flex-col space-y-4">
                <!-- Chat messages will appear here -->
                <div class="p-4 rounded-t-xl rounded-br-xl bg-brand-primary-light text-brand-primary-dark self-start max-w-lg break-words">Hello! I'm your AI Travel Buddy. Once you've generated a trip plan, I can answer your questions about the destination. What would you like to know?</div>
            </div>
            <form id="ai-buddy-form" class="mt-4 flex gap-4">
                <input type="text" id="ai-buddy-input" placeholder="e.g., What should I pack for Day 2?" class="w-full border-gray-300 rounded-full focus:ring-brand-primary focus:border-brand-primary" required>
                <button type="submit" class="btn-gradient text-white px-6 py-2.5 rounded-full font-semibold flex-shrink-0">Send</button>
            </form>
        </div>
    </div>
    <div id="privacy-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white p-8 md:p-12 rounded-4xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto relative">
            <button class="modal-close absolute top-4 right-4 text-gray-500 hover:text-black">&times;</button>
            <div class="prose lg:prose-lg max-w-none">
                <h1 class="font-heading text-4xl font-bold text-brand-dark">Privacy Policy</h1>
                <p>This Privacy Policy describes Our policies and procedures on the collection, use and disclosure of Your information when You use the Service and tells You about Your privacy rights and how the law protects You. We use Your Personal data to provide and improve the Service. By using the Service, You agree to the collection and use of information in accordance with this Privacy Policy.</p>
                <h2>Interpretation and Definitions</h2>
                <p>The words of which the initial letter is capitalized have meanings defined under the following conditions. The following definitions shall have the same meaning regardless of whether they appear in singular or in plural.</p>
                <h2>Collecting and Using Your Personal Data</h2>
                <p>While using Our Service, We may ask You to provide Us with certain personally identifiable information that can be used to contact or identify You. Personally identifiable information may include, but is not limited to: Email address, First name and last name, Usage Data.</p>
            </div>
        </div>
    </div>
    <div id="terms-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white p-8 md:p-12 rounded-4xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto relative">
             <button class="modal-close absolute top-4 right-4 text-gray-500 hover:text-black">&times;</button>
             <div class="prose lg:prose-lg max-w-none">
                <h1 class="font-heading text-4xl font-bold text-brand-dark">Terms of Service</h1>
                <p>Please read these terms and conditions carefully before using Our Service. By accessing or using the Service you agree to be bound by these Terms and Conditions. If you disagree with any part of the terms then you may not access the Service.</p>
                <h2>Acknowledgment</h2>
                <p>These are the Terms and Conditions governing the use of this Service and the agreement that operates between You and the Company. These Terms and Conditions set out the rights and obligations of all users regarding the use of the Service.</p>
                <h2>Intellectual Property</h2>
                <p>The Service and its original content (excluding Content provided by You or other users), features and functionality are and will remain the exclusive property of the Company and its licensors. The Service is protected by copyright, trademark, and other laws of both the Country and foreign countries.</p>
            </div>
        </div>
    </div>
    <div id="trip-planner-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white p-8 md:p-12 rounded-4xl shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <!-- Trip Planner Quiz / Results will be injected here -->
        </div>
    </div>

    <!-- "My Itinerary" Modal -->
    <div id="my-itinerary-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white p-8 md:p-12 rounded-4xl shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto relative flex flex-col">
             <button class="modal-close absolute top-4 right-4 text-gray-500 hover:text-black text-2xl">&times;</button>
             <div class="text-center mb-6">
                <p class="font-semibold text-brand-primary">YOUR SAVED ITINERARY</p>
                <h2 class="font-heading text-4xl font-bold text-brand-dark mt-2">Your Current Trip</h2>
             </div>
             <div id="my-itinerary-content" class="gemini-content prose max-w-none flex-grow overflow-y-auto">
                <!-- Saved itinerary will be injected here -->
             </div>
             <div class="mt-8 pt-6 border-t flex flex-col sm:flex-row gap-4">
                <button id="itinerary-clear-btn" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-full hover:bg-red-700 transition-colors">
                    Clear Itinerary (Trip is Over)
                </button>
                <button data-modal-trigger="journey-modal" id="itinerary-open-buddy-btn" class="w-full bg-brand-primary text-white font-bold py-3 px-4 rounded-full hover:bg-brand-primary-dark transition-colors">
                    Open AI Buddy
                </button>
             </div>
        </div>
    </div>


    <!-- Main Application Script -->
    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CONFIGURATION ---

        // This is your Gemini API key.
        const YOUR_GEMINI_API_KEY = "AIzaSyD_uJX6JaRGIRdi-DK82bUXB9yHDS6lWjE";
        
        // This is your Firebase config object.
        const YOUR_FIREBASE_CONFIG_JSON = {
          apiKey: "AIzaSyBlb9Ye7elbpj19Y7TrHOq5eNS_02rK-44",
          authDomain: "before-you-go-10236.firebaseapp.com",
          projectId: "before-you-go-10236",
          storageBucket: "before-you-go-10236.firebasestorage.app",
          messagingSenderId: "746797011005",
          appId: "1:746797011005:web:5cd09abe929b708d0eda54",
          measurementId: "G-PKLHME3VJD"
        };


        // --- 2. GLOBAL STATE & VARIABLES ---
        let db, auth; // Firebase services
        let currentUserId = null; // To store the user's ID
        let currentModal = null; // To manage which modal is open
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // For Firestore path

        const userState = {
            persona: null,
            tripPreferences: {
                category: null,
                budget: null,
                distance: null,
                duration: null
            },
            lastGeneratedDestinations: [],
            lastGeneratedItinerary: null,
            lastGeneratedGems: null
        };

        // --- 3. CORE FUNCTIONS (Modals, API) ---

        // --- Modal & UI Logic ---
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        mobileMenuBtn.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));

        const triggers = document.querySelectorAll('[data-modal-trigger]');
        triggers.forEach(trigger => {
            trigger.addEventListener('click', (e) => {
                const modalId = e.currentTarget.getAttribute('data-modal-trigger');
                openModal(document.getElementById(modalId));
            });
        });
        
        document.addEventListener('click', e => {
            if (e.target.matches('.modal') || e.target.matches('.modal-close')) {
                const modalToClose = e.target.closest('.modal');
                if (modalToClose) {
                    closeModal(modalToClose);
                }
            }
        });

        function openModal(modal) {
            if (!modal) return;
            // Close any currently open modal before opening a new one
            if (currentModal) {
                closeModal(currentModal);
            }
            document.body.style.overflow = 'hidden';
            modal.classList.add('is-open');
            currentModal = modal;
            // Special handlers for dynamic modals
            const modalId = modal.id;
            if (modalId === 'quiz-modal') loadPersonaQuiz(modal);
            if (modalId === 'journey-modal') setupAIBuddy();
            if (modalId === 'my-itinerary-modal') loadMyItinerary();
        }

        function closeModal(modal) {
            if (!modal) return;
            modal.classList.remove('is-open');
            if (document.querySelectorAll('.modal.is-open').length === 0) {
                document.body.style.overflow = 'auto';
            }
            if (currentModal === modal) {
                currentModal = null;
            }
        }

        // --- Gemini API Call Function ---
        async function callGemini(prompt, systemInstruction = "You are a helpful and creative travel assistant.", isJson = false) {
            const apiKey = YOUR_GEMINI_API_KEY;
            if (!apiKey) {
                console.error("Gemini API key is missing!");
                return `<p class="text-red-500">Error: AI configuration is missing. Please contact support.</p>`;
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };

            if (isJson) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "name": { "type": "STRING" },
                                "description": { "type": "STRING" },
                                "imageQuery": { "type": "STRING" }
                            }
                        }
                    }
                };
            }

            let retries = 3;
            let delay = 1000;

            while (retries > 0) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error("API Error Response:", errorBody);
                        throw new Error(`API Error: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        return candidate.content.parts[0].text;
                    } else {
                        console.error("Invalid API response structure:", result);
                        throw new Error("Invalid API response structure.");
                    }
                } catch (error) {
                    console.warn(`Gemini API call failed. Retrying in ${delay}ms...`, error);
                    retries--;
                    if (retries === 0) {
                        console.error("Gemini API call failed after all retries.", error);
                        return isJson ? "[]" : `<p class="text-red-500">Sorry, the AI is currently unavailable. Please try again later.</p>`;
                    }
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2; // Exponential backoff
                }
            }
        }

        // --- 4. DYNAMIC/QUIZ LOGIC ---

        // --- Dynamic Inspiration Section ---
        const inspirationCategories = {
             'explorer': [
                { name: 'Mountain Expeditions', category: 'mountains', img: 'https://images.pexels.com/photos/691668/pexels-photo-691668.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2' },
                { name: 'Jungle Treks', category: 'jungle', img: 'https://images.pexels.com/photos/2739013/pexels-photo-2739013.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2' },
                { name: 'Off-Grid Adventures', category: 'off-grid', img: 'https://images.pexels.com/photos/1687845/pexels-photo-1687845.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2' },
            ],
            'story-collector': [
                { name: 'Historic Cities', category: 'historic', img: 'https://images.pexels.com/photos/532255/pexels-photo-532255.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2' },
                { name: 'Culinary Tours', category: 'food', img: 'https://images.pexels.com/photos/1640777/pexels-photo-1640777.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2' },
                { name: 'Art & Museums', category: 'art', img: 'https://images.pexels.com/photos/802024/pexels-photo-802024.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2' },
            ],
            'soul-seeker': [
                { name: 'Beach Escapes', category: 'beach', img: 'https://images.pexels.com/photos/1032650/pexels-photo-1032650.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2' },
                { name: 'Wellness Retreats', category: 'wellness', img: 'https://images.pexels.com/photos/3768916/pexels-photo-3768916.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2' },
                { name: 'Lakeside Serenity', category: 'lake', img: 'https://images.pexels.com/photos/462024/pexels-photo-462024.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2' },
            ],
            'thrill-chaser': [
                { name: 'Adrenaline Sports', category: 'sports', img: 'https://images.pexels.com/photos/3764567/pexels-photo-3764567.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2' },
                { name: 'Epic Treks', category: 'trekking', img: 'https://images.pexels.com/photos/572897/pexels-photo-572897.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2' },
                { name: 'Water Adventures', category: 'water', img: 'https://images.pexels.com/photos/1684151/pexels-photo-1684151.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2' },
            ]
        };

        function updateInspirationSection(persona = null) {
            const subtitle = document.getElementById('inspiration-subtitle');
            const grid = document.getElementById('inspiration-grid');
            
            const categories = persona ? inspirationCategories[persona] : [
                { name: 'The Explorer', category: 'explorer-default', img: 'https://images.pexels.com/photos/1562/italian-landscape-mountains-nature.jpg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2' },
                { name: 'The Soul Seeker', category: 'soul-seeker-default', img: 'https://images.pexels.com/photos/1450360/pexels-photo-1450360.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2' },
                { name: 'The Story Collector', category: 'story-collector-default', img: 'https://images.pexels.com/photos/210307/pexels-photo-210307.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2' }
            ];
            
            subtitle.textContent = persona 
                ? `Based on your persona, here are some trip styles you might love. Select one to plan your trip!`
                : `First, take the quiz to reveal your travel persona and unlock personalized suggestions!`;
            
            grid.innerHTML = ''; // Clear default content
            
            categories.forEach(cat => {
                const card = document.createElement(persona ? 'button' : 'div');
                card.dataset.category = cat.category;
                card.className = "inspiration-card relative rounded-2xl shadow-lg overflow-hidden h-96 group card-hover text-left";
                if (!persona) {
                    card.classList.add("cursor-not-allowed", "opacity-80");
                }
                
                card.innerHTML = `
                    <img src="${cat.img}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" alt="${cat.name}">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent flex items-end p-6">
                        <h3 class="text-white text-2xl font-heading font-bold">${cat.name}</h3>
                    </div>
                `;
                grid.appendChild(card);

                if (persona) {
                    card.addEventListener('click', () => {
                        userState.tripPreferences.category = card.getAttribute('data-category');
                        const modal = document.getElementById('trip-planner-modal');
                        openModal(modal);
                        loadTripPlannerQuiz(modal);
                    });
                }
            });
        }
        
        // --- Persona Quiz Logic ---
        const personaQuizQuestions = [
            { question: "A week off just opened up. Your first thought is:", options: [ { text: "Find a hidden cabin in the mountains.", value: "explorer" }, { text: "Finally, time to visit that famous museum.", value: "story-collector" }, { text: "Book a flight somewhere warm, now!", value: "soul-seeker" }, { text: "Check for last-minute adventure deals.", value: "thrill-chaser" } ] },
            { question: "The ideal pace for a vacation day is:", options: [ { text: "Packed from sunrise to sunset with activities.", value: "thrill-chaser" }, { text: "A loose plan with plenty of room for spontaneity.", value: "explorer" }, { text: "One or two main cultural sights, with lots of cafe breaks.", value: "story-collector" }, { text: "Having zero obligations is the whole point.", value: "soul-seeker" } ] },
            { question: "When you hear 'local cuisine', you think:", options: [ { text: " Michelin-starred restaurants with a famous chef.", value: "story-collector" }, { text: "Busy street food stalls everyone is talking about.", value: "explorer" }, { text: "Fresh, healthy food at a beachfront cafe.", value: "soul-seeker" }, { text: "Quick, high-energy food to fuel my activities.", value: "thrill-chaser" } ] },
            { question: "Your preferred travel companion is:", options: [ { text: "A group of friends who are up for anything.", value: "thrill-chaser" }, { text: "My partner, for a shared experience.", value: "soul-seeker" }, { text: "Just myself and a map.", value: "explorer" }, { text: "My family or a friend who loves history.", value: "story-collector" } ] },
            { question: "The perfect souvenir is:", options: [ { text: "A piece of art from a local gallery.", value: "story-collector" }, { text: "Just the memories and photos.", value: "thrill-chaser" }, { text: "An interesting rock or shell from a remote place.", value: "explorer" }, { text: "A handmade bracelet that supports local artisans.", value: "soul-seeker" } ] },
            { question: "A 'great view' means:", options: [ { text: "Looking down from the top of a mountain I just climbed.", value: "thrill-chaser" }, { text: "A panoramic city skyline from a rooftop bar.", value: "story-collector" }, { text: "An endless, empty desert or forest.", value: "explorer" }, { text: "The ocean from my private balcony.", value: "soul-seeker" } ] },
            { question: "How much of your trip do you document on social media?", options: [ { text: "I post stories all day to share the experience live.", value: "thrill-chaser" }, { text: "A curated post at the end of each day.", value: "story-collector" }, { text: "Maybe one or two photos if I remember.", value: "explorer" }, { text: "My phone is off most of the time.", value: "soul-seeker" } ] },
            { question: "What does 'luxury' mean to you on a trip?", options: [ { text: "Having a private guide and exclusive access.", value: "story-collector" }, { text: "Time and silence.", value: "soul-seeker" }, { text: "Top-of-the-line gear for my adventures.", value: "thrill-chaser" }, { text: "The freedom to have no fixed address.", value: "explorer" } ] },
            { question: "You're lost in a new city. You:", options: [ { text: "Embrace it. This is where the adventure begins.", value: "explorer" }, { text: "Ask a local shopkeeper for directions and a story.", value: "story-collector" }, { text: "Use it as an opportunity to find a quiet park and relax.", value: "soul-seeker" }, { text: "See it as a race to find my way back.", value: "thrill-chaser" } ] },
            { question: "The most important part of your accommodation is:", options: [ { text: "Proximity to nature trails or adventure spots.", value: "thrill-chaser" }, { text: "A central location in a historic district.", value: "story-collector" }, { text: "Complete isolation and privacy.", value: "explorer" }, { text: "A comfortable bed and a peaceful atmosphere.", value: "soul-seeker" } ] },
            { question: "What kind of museum would you choose?", options: [ { text: "A modern art museum with challenging exhibits.", value: "story-collector" }, { text: "An outdoor museum or historical reenactment.", value: "explorer" }, { text: "A small, quirky museum about a local legend.", value: "story-collector" }, { text: "I'd rather be outside than in a museum.", value: "thrill-chaser" } ] },
            { question: "Your ideal evening on vacation ends with:", options: [ { text: "Stargazing far from city lights.", value: "explorer" }, { text: "A quiet glass of wine and reflection.", value: "soul-seeker" }, { text: "Sharing stories with new friends at a bonfire.", value: "thrill-chaser" }, { text: "Seeing a play or a live music performance.", value: "story-collector" } ] },
            { question: "Which travel movie character are you?", options: [ { text: "Indiana Jones, searching for ancient artifacts.", value: "explorer" }, { text: "Elizabeth Gilbert in 'Eat Pray Love', on a journey of self-discovery.", value: "soul-seeker" }, { text: "James Bond, on a glamorous and action-packed mission.", value: "thrill-chaser" }, { text: "The narrator in 'Amélie', finding magic in everyday city life.", value: "story-collector" } ] },
            { question: "The best travel photos are:", options: [ { text: "Candid shots of people and daily life.", value: "story-collector" }, { text: "Epic, wide-angle landscapes with no people.", value: "explorer" }, { text: "Action shots of an activity.", value: "thrill-chaser" }, { text: "Peaceful sunrises or sunsets.", value: "soul-seeker" } ] },
            { question: "After a trip, you feel most fulfilled by:", options: [ { text: "The new skills or knowledge you acquired.", value: "story-collector" }, { text: "The sense of peace and rejuvenation.", value: "soul-seeker" }, { text: "The stories of the challenges you overcame.", value: "thrill-chaser" }, { text: "Knowing you saw a place few others have seen.", value: "explorer" } ] }
        ];
        
        const personaQuizResults = {
            'explorer': { persona: "The Explorer", title: "Your DNA is set for discovery!", description: "You're driven by curiosity and a desire to get off the beaten path. You crave authenticity and aren't afraid of a little unpredictability. Now, let's find your next great adventure below!" },
            'story-collector': { persona: "The Story Collector", title: "You're a cultural connoisseur!", description: "You travel to learn, to taste, and to immerse yourself in the rich tapestry of human history and creativity. Your perfect trip is filled with stories. Let's find your next chapter below!" },
            'soul-seeker': { persona: "The Soul Seeker", title: "You travel to reconnect!", description: "For you, a journey is a chance to recharge, reflect, and find tranquility. Comfort, beauty, and peace are your priorities. Let's find your sanctuary below!" },
            'thrill-chaser': { persona: "The Thrill Chaser", title: "You're an adrenaline junkie!", description: "You see the world as a playground and travel as a chance to push your limits. Your ideal trip gets your heart pumping. Let's find your next epic challenge below!" }
        };

        function loadPersonaQuiz(modal) {
            const container = modal.querySelector('.modal-content');
            let currentQuestionIndex = 0;
            const userAnswers = {};

            function render() {
                if (currentQuestionIndex === -1) { // Intro screen
                    container.innerHTML = `
                        <button class="modal-close absolute top-4 right-4 text-gray-500 hover:text-black text-2xl">&times;</button>
                        <div class="text-center">
                            <p class="font-semibold text-brand-primary">WELCOME</p>
                            <h2 class="font-heading text-4xl font-bold text-brand-dark mt-2">Find Your Travel DNA</h2>
                            <p class="text-lg text-gray-700 mt-4">This quick, psychology-backed quiz helps us understand what truly motivates you to travel.</p>
                            <p class="mt-2 text-gray-600">Answer 15 questions to reveal your unique travel persona and unlock personalized AI recommendations.</p>
                            <button id="start-quiz-btn" class="mt-8 bg-brand-accent text-white px-8 py-3 rounded-full font-bold hover:bg-brand-accent-hover">
                                Start the Quiz
                            </button>
                        </div>
                    `;
                    container.querySelector('#start-quiz-btn').addEventListener('click', () => {
                        currentQuestionIndex = 0;
                        render();
                    });
                    return;
                }

                const questionData = personaQuizQuestions[currentQuestionIndex];
                let optionsHTML = '';
                questionData.options.forEach((option, i) => {
                    const isSelected = userAnswers[currentQuestionIndex] === option.value;
                    optionsHTML += `<button data-value="${option.value}" class="quiz-option w-full text-left cursor-pointer border-2 ${isSelected ? 'border-brand-primary bg-brand-primary-light text-brand-primary-dark' : 'border-gray-200'} rounded-2xl p-4 mt-4 font-medium hover:border-brand-primary">${option.text}</button>`;
                });

                container.innerHTML = `
                    <button class="modal-close absolute top-4 right-4 text-gray-500 hover:text-black text-2xl">&times;</button>
                    <div id="quiz-container">
                        <div class="mb-8">
                            <span id="progress-text" class="text-sm font-medium text-brand-primary">Question ${currentQuestionIndex + 1} of ${personaQuizQuestions.length}</span>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2"><div id="progress-bar" class="bg-brand-primary h-2.5 rounded-full" style="width: ${((currentQuestionIndex + 1) / personaQuizQuestions.length) * 100}%"></div></div>
                        </div>
                        <h2 class="font-heading text-2xl md:text-3xl font-bold text-brand-dark">${questionData.question}</h2>
                        <div class="mt-6">${optionsHTML}</div>
                    </div>
                    <div class="mt-10 flex justify-between items-center">
                        <button id="prev-btn" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-full font-semibold hover:bg-gray-300 disabled:opacity-50">Previous</button>
                        <button id="next-btn" class="bg-brand-accent text-white px-8 py-3 rounded-full font-bold hover:bg-brand-accent-hover shadow-md" disabled>${currentQuestionIndex === personaQuizQuestions.length - 1 ? 'Reveal My Persona!' : 'Next Question'}</button>
                    </div>
                `;
                
                container.querySelector('#prev-btn').disabled = currentQuestionIndex === 0;
                container.querySelector('#prev-btn').addEventListener('click', () => { if(currentQuestionIndex > 0) { currentQuestionIndex--; render(); }});
                
                const nextBtn = container.querySelector('#next-btn');
                if (userAnswers[currentQuestionIndex]) {
                    nextBtn.disabled = false;
                }
                nextBtn.addEventListener('click', handleNext);

                container.querySelectorAll('.quiz-option').forEach(opt => opt.addEventListener('click', e => {
                    const value = e.currentTarget.getAttribute('data-value');
                    userAnswers[currentQuestionIndex] = value;
                    render(); // Re-render to show selection
                    
                    // Auto-next
                    setTimeout(() => {
                        handleNext();
                    }, 300); // 300ms delay
                }));
            }

            function handleNext() {
                if(userAnswers[currentQuestionIndex] === undefined) return; 

                if (currentQuestionIndex < personaQuizQuestions.length - 1) {
                    currentQuestionIndex++;
                    render();
                } else {
                    handleQuizComplete();
                }
            }

            function calculatePersona() {
                const vote = { 'explorer': 0, 'story-collector': 0, 'soul-seeker': 0, 'thrill-chaser': 0 };
                for(let i = 0; i < personaQuizQuestions.length; i++) {
                    const answerValue = userAnswers[i];
                    if(answerValue) {
                        vote[answerValue]++;
                    }
                }
                let maxVotes = 0;
                let finalPersona = 'explorer'; // Default
                for (const persona in vote) {
                    if (vote[persona] > maxVotes) {
                        maxVotes = vote[persona];
                        finalPersona = persona;
                    }
                }
                return finalPersona;
            }

            async function handleQuizComplete() {
                const persona = calculatePersona();
                userState.persona = persona;
                
                // Save to Firestore
                await saveUserData({ persona: persona });

                const resultData = personaQuizResults[persona];
                container.innerHTML = `
                    <div class="text-center animate-fade-in-up">
                        <p class="font-semibold text-brand-primary">YOUR TRAVEL DNA</p>
                        <h2 class="font-heading text-4xl font-bold text-brand-dark mt-2">${resultData.persona}</h2>
                        <p class="text-lg text-gray-700 mt-4">${resultData.title}</p>
                        <p class="mt-2 text-gray-600">${resultData.description}</p>
                        <button id="show-inspiration-btn" class="mt-8 bg-brand-accent text-white px-8 py-3 rounded-full font-bold hover:bg-brand-accent-hover">Let's Go!</button>
                    </div>
                `;
                document.getElementById('show-inspiration-btn').addEventListener('click', () => {
                    closeModal(modal);
                    updateInspirationSection(persona);
                    document.getElementById('inspiration').scrollIntoView({ behavior: 'smooth' });
                });
            }

            currentQuestionIndex = -1; // Start at intro screen
            render();
        }

        // --- Trip Planner Quiz & Destination Logic ---
        const tripPlannerQuestions = [
            { id: 'distance', question: 'How far are you looking to go?', options: [ {text: 'Stay Domestic', value: 'domestic'}, {text: 'Short-Haul (Nearby Countries)', value: 'short-haul'}, {text: 'Long-Haul (Across the Globe)', value: 'long-haul'}] },
            { id: 'duration', question: 'How long is your trip?', options: [ {text: 'A Weekend Getaway (2-4 days)', value: 'weekend'}, {text: 'About a Week (5-10 days)', value: 'week'}, {text: 'A Long Expedition (10+ days)', value: 'expedition'}] },
            { id: 'budget', question: 'What is your travel budget style?', options: [ {text: 'Budget-Friendly (Hostels, street food)', value: 'budget'}, {text: 'Mid-Range (Comfortable hotels, mix of dining)', value: 'mid-range'}, {text: 'Luxury (High-end resorts, fine dining)', value: 'luxury'}] }
        ];

        function loadTripPlannerQuiz(modal) {
            const container = modal.querySelector('.modal-content');
            let currentQuestionIndex = 0;
            
            // Clear old prefs but keep category
            userState.tripPreferences = { category: userState.tripPreferences.category };
            
            function render() {
                const questionData = tripPlannerQuestions[currentQuestionIndex];
                 let optionsHTML = '';
                questionData.options.forEach((option, i) => {
                    const isSelected = userState.tripPreferences[questionData.id] === option.value;
                    optionsHTML += `<button data-value="${option.value}" data-id="${questionData.id}" class="quiz-option w-full text-left cursor-pointer border-2 ${isSelected ? 'border-brand-primary bg-brand-primary-light text-brand-primary-dark' : 'border-gray-200'} rounded-2xl p-4 mt-4 font-medium hover:border-brand-primary">${option.text}</button>`;
                });
                
                container.innerHTML = `
                    <button class="modal-close absolute top-4 right-4 text-gray-500 hover:text-black text-2xl">&times;</button>
                    <div id="trip-planner-container">
                        <div class="mb-8 text-center">
                            <h2 class="font-heading text-3xl font-bold text-brand-dark">Plan Your Trip</h2>
                            <p class="text-gray-600">A few more details to find your perfect destination.</p>
                             <p class="mt-2 text-sm font-semibold text-brand-primary">Category: ${userState.tripPreferences.category}</p>
                        </div>
                        <h3 class="font-heading text-xl font-bold text-brand-dark mt-6">${questionData.question}</h3>
                        <div>${optionsHTML}</div>
                    </div>
                    <div class="mt-10 flex justify-end">
                        <button id="generate-trip-btn" class="bg-brand-accent text-white px-8 py-3 rounded-full font-bold hover:bg-brand-accent-hover shadow-md" disabled>${currentQuestionIndex === tripPlannerQuestions.length - 1 ? 'Find Destinations!' : 'Next'}</button>
                    </div>
                `;
                
                const generateBtn = container.querySelector('#generate-trip-btn');
                if (userState.tripPreferences[questionData.id]) {
                     generateBtn.disabled = false;
                }

                container.querySelectorAll('.quiz-option').forEach(opt => opt.addEventListener('click', e => {
                    const value = e.currentTarget.getAttribute('data-value');
                    const id = e.currentTarget.getAttribute('data-id');
                    userState.tripPreferences[id] = value;
                    
                    // Auto-next
                    if (currentQuestionIndex < tripPlannerQuestions.length - 1) {
                        currentQuestionIndex++;
                        render();
                    } else {
                        // On last question, just re-render to enable button
                        render();
                    }
                }));

                generateBtn.addEventListener('click', () => {
                    if (currentQuestionIndex < tripPlannerQuestions.length - 1) {
                         currentQuestionIndex++;
                         render();
                    } else if (userState.tripPreferences.budget && userState.tripPreferences.distance && userState.tripPreferences.duration) {
                        handleGenerateDestinations();
                    }
                });
            }
            render();
        }
        
        async function handleGenerateDestinations() {
            // Show a loading state inside the current modal
            const container = currentModal.querySelector('.modal-content');
            container.innerHTML = `
                <div class="text-center animate-fade-in-up">
                    <p class="font-semibold text-brand-primary">YOUR CURATED DESTINATIONS</p>
                    <h2 class="font-heading text-4xl font-bold text-brand-dark mt-2">Here Are Your Matches</h2>
                    <div class="my-12 flex flex-col items-center justify-center">
                        <div class="w-12 h-12 rounded-full animate-spin border-4 border-dashed border-brand-primary border-t-transparent"></div>
                        <p class="text-lg text-gray-700 mt-4">Our AI is scanning the globe for you...</p>
                    </div>
                    <button class="modal-close mt-8 bg-brand-accent text-white px-8 py-3 rounded-full font-bold" disabled>Loading...</button>
                </div>
            `;

            const { persona, tripPreferences } = userState;
            const prompt = `Act as a world-class travel expert. A user with the travel persona of a '${persona}' is planning a '${tripPreferences.duration}' trip. Their travel distance is '${tripPreferences.distance}', their budget is '${tripPreferences.budget}', and their main interest is '${tripPreferences.category}'.
Generate 3 unique, specific destinations (e.g., "Kyoto, Japan", "Patagonia, Chile", "Sedona, Arizona") that are a *perfect* match for this user.
For each destination, provide a "name", a 1-2 sentence "description", and a 2-3 word "imageQuery" for a stock photo (e.g., "Patagonia mountains", "Kyoto temple").
Respond *only* with the valid JSON array.`;

            const systemInstruction = "You are a travel API that returns only JSON.";
            
            const destinationsText = await callGemini(prompt, systemInstruction, true);
            let destinations = [];
            try {
                destinations = JSON.parse(destinationsText);
            } catch (e) {
                console.error("Failed to parse destinations JSON:", e);
                destinations = [];
            }

            userState.lastGeneratedDestinations = destinations;
            await saveUserData({ lastGeneratedDestinations: destinations });

            renderTripResults(destinations, container);
        }

        function renderTripResults(destinations, container) {
            let resultsHTML = '';

            if (destinations && destinations.length > 0) {
                 destinations.forEach((dest, index) => {
                    resultsHTML += `
                        <div class="border bg-gray-50 rounded-2xl p-6 mt-6">
                             <div class="flex justify-between items-center">
                                <h3 class="font-heading text-2xl font-bold text-brand-dark">${dest.name}</h3>
                                <button data-details-target="${index}" class="view-details-btn text-brand-primary font-bold">View Details</button>
                             </div>
                             <div id="details-${index}" class="trip-details mt-4">
                                <img src="https://placehold.co/600x400/14B8A6/white?text=${encodeURIComponent(dest.imageQuery)}" class="rounded-xl aspect-video object-cover w-full" alt="${dest.name}">
                                <div id="itinerary-container-${index}" class="mt-4">
                                    <p class="text-gray-600 mt-4">${dest.description}</p>
                                    <button data-dest-index="${index}" class="generate-itinerary-btn mt-4 w-full bg-brand-primary text-white font-bold py-3 px-4 rounded-full flex items-center justify-center gap-2">
                                        ✨ Generate Detailed Itinerary
                                    </button>
                                </div>
                                <div class="mt-6 flex flex-col sm:flex-row gap-4">
                                    <a href="https://www.makemytrip.com/" target="_blank" class="w-full text-center bg-gray-800 text-white font-bold py-2 px-4 rounded-full">Book Flights</a>
                                    <a href="https://www.airbnb.com/" target="_blank" class="w-full text-center bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-full">Book Hotels</a>
                                </div>
                             </div>
                        </div>
                    `;
                 });
            } else {
                resultsHTML = `<p class="text-center text-red-500 mt-8">Sorry, our AI couldn't find destinations for that combo. Please try again!</p>`;
            }

            container.innerHTML = `
                <button class="modal-close absolute top-4 right-4 text-gray-500 hover:text-black text-2xl">&times;</button>
                <div class="text-center animate-fade-in-up">
                    <p class="font-semibold text-brand-primary">YOUR CURATED DESTINATIONS</p>
                    <h2 class="font-heading text-4xl font-bold text-brand-dark mt-2">Here Are Your Matches</h2>
                    <div id="results-container" class="my-8 text-left max-w-none">${resultsHTML}</div>
                    <button class="modal-close mt-8 bg-brand-accent text-white px-8 py-3 rounded-full font-bold hover:bg-brand-accent-hover">Start Over</button>
                </div>
            `;
            
            container.querySelectorAll('.view-details-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const targetId = e.currentTarget.getAttribute('data-details-target');
                    const detailsDiv = document.getElementById(`details-${targetId}`);
                    if (detailsDiv.style.maxHeight) {
                        detailsDiv.style.maxHeight = null;
                        e.currentTarget.textContent = "View Details";
                    } else {
                        detailsDiv.style.maxHeight = detailsDiv.scrollHeight + "px";
                        e.currentTarget.textContent = "Hide Details";
                    }
                });
            });

            container.querySelectorAll('.generate-itinerary-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const destIndex = e.currentTarget.getAttribute('data-dest-index');
                    const destination = destinations[destIndex];
                    handleGenerateItinerary(destination, destIndex);
                });
            });
        }
        
        async function handleGenerateItinerary(destination, destIndex) {
            const container = document.getElementById(`itinerary-container-${destIndex}`);
            const button = container.querySelector('.generate-itinerary-btn');
            button.innerHTML = `<div class="spinner"></div><span>Generating...</span>`;
            button.disabled = true;

            const { persona, tripPreferences } = userState;
            const prompt = `
                You are an expert travel planner. A user with the travel persona of a '${persona}' 
                is planning a '${tripPreferences.duration}' trip to '${destination.name}' on a 
                '${tripPreferences.budget}' budget. Their main interest is '${tripPreferences.category}'.
                
                Generate a detailed, day-by-day itinerary for them. Make it engaging, exciting, 
                and specific to their persona. Use markdown for formatting with headings for each day (e.g., "### Day 1: Arrival").
            `;
            
            const itineraryHTML = await callGemini(prompt);
            userState.lastGeneratedItinerary = itineraryHTML;
            await saveUserData({ lastGeneratedItinerary: itineraryHTML });
            
            // Show "My Itinerary" button
            document.getElementById('my-itinerary-btn').classList.remove('hidden');
            document.getElementById('my-itinerary-btn-mobile').classList.remove('hidden');

            container.innerHTML = `
                <div class="gemini-content">${marked.parse(itineraryHTML)}</div>
                <button data-dest-name="${destination.name}" class="find-gems-btn mt-4 w-full bg-brand-accent text-white font-bold py-3 px-4 rounded-full flex items-center justify-center gap-2">
                    ✨ Suggest Hidden Gems
                </button>
            `;
            
            container.querySelector('.find-gems-btn').addEventListener('click', e => {
                const destName = e.currentTarget.getAttribute('data-dest-name');
                handleFindHiddenGems(destName, container);
            });

            // Make sure the collapsible section resizes correctly
            const detailsDiv = document.getElementById(`details-${destIndex}`);
            if (detailsDiv) {
                detailsDiv.style.maxHeight = detailsDiv.scrollHeight + "px";
            }
        }

        async function handleFindHiddenGems(destinationName, container) {
            const button = container.querySelector('.find-gems-btn');
            button.innerHTML = `<div class="spinner"></div><span>Finding Gems...</span>`;
            button.disabled = true;
            
            const { persona } = userState;
            const prompt = `
                You are a local expert for '${destinationName}'. A tourist with the travel persona 
                of a '${persona}' is visiting. Suggest 3 unique, non-touristy 'hidden gems' 
                (like a specific cafe, a small museum, a beautiful walking path, or a local market) 
                that they would love. For each suggestion, briefly explain why it fits their persona.
                Use markdown for formatting.
            `;
            
            const gemsHTML = await callGemini(prompt, `You are a local guide with deep knowledge of hidden gems.`);
            userState.lastGeneratedGems = gemsHTML;
            await saveUserData({ lastGeneratedGems: gemsHTML });
            
            const gemsContainer = document.createElement('div');
            gemsContainer.className = "gemini-content mt-4 border-t pt-4";
            gemsContainer.innerHTML = marked.parse(gemsHTML);
            container.appendChild(gemsContainer);
            button.style.display = 'none'; // Hide button after use

            // Make sure the collapsible section resizes correctly
            const detailsDiv = container.closest('.trip-details');
            if (detailsDiv) {
                detailsDiv.style.maxHeight = detailsDiv.scrollHeight + "px";
            }
        }
        
        function setupAIBuddy() {
            const form = document.getElementById('ai-buddy-form');
            const input = document.getElementById('ai-buddy-input');
            const chatWindow = document.getElementById('ai-buddy-chat-window');
            
            // Clear default message
            chatWindow.innerHTML = '';
            let aiWelcomeMessage = "Hello! I'm your AI Travel Buddy. What can I help you with today?";
            
            if (userState.lastGeneratedItinerary) {
                const destName = userState.lastGeneratedDestinations[0]?.name || 'your trip';
                aiWelcomeMessage = `Hello! I see you've generated an itinerary for ${destName}. Ask me anything about it, like packing tips for Day 2 or local customs!`;
            }

            const welcomeBubble = document.createElement('div');
            welcomeBubble.className = "p-4 rounded-t-xl rounded-br-xl bg-brand-primary-light text-brand-primary-dark self-start max-w-lg break-words";
            welcomeBubble.innerHTML = marked.parse(aiWelcomeMessage);
            chatWindow.appendChild(welcomeBubble);

            // This is a one-time setup, so we use a flag to prevent multiple listeners
            if (form.dataset.initialized) return;
            form.dataset.initialized = true;

            form.addEventListener('submit', async e => {
                e.preventDefault();
                const userMessage = input.value.trim();
                if (!userMessage) return;

                // Add user message to window
                const userBubble = document.createElement('div');
                userBubble.className = "p-4 rounded-t-xl rounded-bl-xl bg-brand-accent text-white self-end max-w-lg break-words";
                userBubble.textContent = userMessage;
                chatWindow.appendChild(userBubble);
                input.value = '';
                chatWindow.scrollTop = chatWindow.scrollHeight;

                // Add loading indicator
                const loadingBubble = document.createElement('div');
                loadingBubble.className = "p-4 rounded-t-xl rounded-br-xl bg-brand-primary-light text-brand-primary-dark self-start max-w-lg flex items-center break-words";
                loadingBubble.innerHTML = `<div class="spinner mr-2"></div> Thinking...`;
                chatWindow.appendChild(loadingBubble);
                chatWindow.scrollTop = chatWindow.scrollHeight;
                
                let systemContext = `You are the 'AI Travel Buddy'. Be friendly, helpful, and concise.`;
                if (userState.lastGeneratedItinerary) {
                    systemContext += ` The user has the following itinerary planned, use it to answer their questions: \n\n ${userState.lastGeneratedItinerary}`;
                }
                if (userState.lastGeneratedGems) {
                    systemContext += ` \n\n They are also aware of these hidden gems: \n\n ${userState.lastGeneratedGems}`;
                }
                
                const systemPrompt = systemContext;
                const responseHTML = await callGemini(userMessage, systemPrompt);

                // Replace loading bubble with AI response
                loadingBubble.classList.remove('flex', 'items-center');
                loadingBubble.innerHTML = marked.parse(responseHTML);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            });
        }

        // --- "My Itinerary" Modal Logic ---
        function loadMyItinerary() {
            const contentDiv = document.getElementById('my-itinerary-content');
            if (userState.lastGeneratedItinerary) {
                contentDiv.innerHTML = marked.parse(userState.lastGeneratedItinerary);
            } else {
                contentDiv.innerHTML = `<p class="text-gray-600 text-center">You don't have a saved itinerary yet. Go to the "Inspiration" section to generate one!</p>`;
            }
        }

        async function clearItinerary() {
            userState.lastGeneratedItinerary = null;
            userState.lastGeneratedGems = null;
            userState.lastGeneratedDestinations = [];
            
            // Clear from Firestore
            if (db && currentUserId) {
                 const docRef = doc(db, "artifacts", appId, "users", currentUserId, "travelPlanner", "data");
                 // We update to remove fields, not delete the doc
                 await updateDoc(docRef, {
                    lastGeneratedItinerary: null,
                    lastGeneratedGems: null,
                    lastGeneratedDestinations: []
                 });
            }

            // Hide button and close modal
            document.getElementById('my-itinerary-btn').classList.add('hidden');
            document.getElementById('my-itinerary-btn-mobile').classList.add('hidden');
            closeModal(document.getElementById('my-itinerary-modal'));
        }
        document.getElementById('itinerary-clear-btn').addEventListener('click', clearItinerary);
        document.getElementById('itinerary-open-buddy-btn').addEventListener('click', () => {
             // Close this modal and open the buddy modal
             closeModal(document.getElementById('my-itinerary-modal'));
             openModal(document.getElementById('journey-modal'));
        });

        // --- 5. FIREBASE AUTH & DATA ---

        function updateAuthUI(user) {
            const loadingSpinner = document.getElementById('auth-loading');
            const signInBtn = document.getElementById('auth-signin-btn');
            const userInfo = document.getElementById('auth-user-info');
            const userIdSpan = document.getElementById('auth-user-id');
            const signOutBtn = document.getElementById('auth-signout-btn');
            
            const signInBtnMobile = document.getElementById('auth-signin-btn-mobile');
            const userInfoMobile = document.getElementById('auth-user-info-mobile');
            const userIdSpanMobile = document.getElementById('auth-user-id-mobile');
            
            const itineraryBtn = document.getElementById('my-itinerary-btn');
            const itineraryBtnMobile = document.getElementById('my-itinerary-btn-mobile');

            loadingSpinner.classList.add('hidden');

            if (user && !user.isAnonymous) {
                // User is signed in
                const truncatedId = user.email ? user.email.split('@')[0] : `User: ${user.uid.substring(0, 6)}...`;
                userIdSpan.textContent = `Hi, ${truncatedId}`;
                userIdSpanMobile.textContent = `Hi, ${truncatedId}`;
                
                signInBtn.classList.add('hidden');
                signInBtnMobile.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userInfoMobile.classList.remove('hidden');

                // Check for saved itinerary
                if (userState.lastGeneratedItinerary) {
                    itineraryBtn.classList.remove('hidden');
                    itineraryBtnMobile.classList.remove('hidden');
                }

            } else {
                // User is anonymous or signed out
                signInBtn.classList.remove('hidden');
                signInBtnMobile.classList.remove('hidden');
                userInfo.classList.add('hidden');
                userInfoMobile.classList.add('hidden');
                
                // Hide itinerary button if signed out
                itineraryBtn.classList.add('hidden');
                itineraryBtnMobile.classList.add('hidden');
            }
        }

        async function loadUserData(userId) {
            if (!db || !userId) return;
            try {
                const docRef = doc(db, "artifacts", appId, "users", userId, "travelPlanner", "data");
                const docSnap = await getDoc(docRef);

                const itineraryBtn = document.getElementById('my-itinerary-btn');
                const itineraryBtnMobile = document.getElementById('my-itinerary-btn-mobile');

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Load data into state
                    if (data.persona) {
                        userState.persona = data.persona;
                        updateInspirationSection(data.persona);
                    }
                    if (data.lastGeneratedDestinations) {
                        userState.lastGeneratedDestinations = data.lastGeneratedDestinations;
                    }
                    if (data.lastGeneratedItinerary) {
                        userState.lastGeneratedItinerary = data.lastGeneratedItinerary;
                        itineraryBtn.classList.remove('hidden'); // Show button
                        itineraryBtnMobile.classList.remove('hidden');
                    } else {
                         itineraryBtn.classList.add('hidden'); // Hide button
                         itineraryBtnMobile.classList.add('hidden');
                    }
                    if (data.lastGeneratedGems) {
                        userState.lastGeneratedGems = data.lastGeneratedGems;
                    }
                    console.log("User data loaded from Firestore.");
                } else {
                    console.log("No previous user data found.");
                    // No data, so clear any inspiration filters
                    updateInspirationSection(null);
                    itineraryBtn.classList.add('hidden');
                    itineraryBtnMobile.classList.add('hidden');
                }
            } catch (e) {
                console.error("Error loading user data:", e);
            }
        }

        async function saveUserData(dataToSave) {
            if (!db || !currentUserId || (auth.currentUser && auth.currentUser.isAnonymous)) {
                // Don't save data for anonymous users
                return;
            }
            try {
                const docRef = doc(db, "artifacts", appId, "users", currentUserId, "travelPlanner", "data");
                // Use setDoc with merge: true to update/create
                await setDoc(docRef, dataToSave, { merge: true });
                console.log("User data saved:", dataToSave);
            } catch (e) {
                console.error("Error saving user data:", e);
            }
        }
        
        async function initializeFirebase() {
            // Get config from either environment (Canvas) or local const
            const firebaseConfig = (typeof __firebase_config !== 'undefined') 
                ? JSON.parse(__firebase_config) 
                : YOUR_FIREBASE_CONFIG_JSON;

            // Get initial token from environment (Canvas)
            const initialAuthToken = (typeof __initial_auth_token !== 'undefined')
                ? __initial_auth_token
                : null;

            if (!firebaseConfig.apiKey) {
                console.error("Firebase config is missing!");
                document.getElementById('auth-loading').classList.add('hidden');
                document.getElementById('auth-status').innerHTML = `<span class="text-sm text-red-500">Auth Error</span>`;
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // --- Auth Form Listeners ---
                const authForm = document.getElementById('auth-form');
                const emailInput = document.getElementById('auth-email');
                const passwordInput = document.getElementById('auth-password');
                const loginBtn = document.getElementById('auth-login-btn');
                const signupBtn = document.getElementById('auth-signup-btn');
                const errorMsg = document.getElementById('auth-error-message');
                const signOutBtn = document.getElementById('auth-signout-btn');
                const signOutBtnMobile = document.getElementById('auth-signout-btn-mobile');

                loginBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    errorMsg.classList.add('hidden');
                    try {
                        await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                        closeModal(document.getElementById('auth-modal'));
                        authForm.reset();
                    } catch (error) {
                        errorMsg.textContent = error.message;
                        errorMsg.classList.remove('hidden');
                    }
                });

                signupBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    errorMsg.classList.add('hidden');
                    try {
                        await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                        closeModal(document.getElementById('auth-modal'));
                        authForm.reset();
                    } catch (error) {
                        errorMsg.textContent = error.message;
                        errorMsg.classList.remove('hidden');
                    }
                });

                const handleSignOut = async () => {
                    // Clear local state before signing out
                    userState.persona = null;
                    userState.lastGeneratedDestinations = [];
                    userState.lastGeneratedItinerary = null;
                    userState.lastGeneratedGems = null;
                    
                    await signOut(auth);
                    
                    // After sign out, the onAuthStateChanged listener will fire
                    // and we will sign in anonymously.
                };

                signOutBtn.addEventListener('click', handleSignOut);
                signOutBtnMobile.addEventListener('click', handleSignOut);


                // --- Persistent Auth State Listener ---
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in
                        currentUserId = user.uid;
                        
                        if (!user.isAnonymous) {
                            // If it's a *real* user, load their data
                            await loadUserData(user.uid);
                        } else {
                            // It's an anonymous user, reset/clear inspiration
                            userState.persona = null;
                            userState.lastGeneratedItinerary = null;
                            updateInspirationSection(null);
                            document.getElementById('my-itinerary-btn').classList.add('hidden');
                            document.getElementById('my-itinerary-btn-mobile').classList.add('hidden');
                        }
                        updateAuthUI(user);

                    } else {
                        // User is signed out, sign in anonymously
                        currentUserId = null;
                        updateAuthUI(null);
                        updateInspirationSection(null);
                        try {
                            await signInAnonymously(auth);
                        } catch (e) {
                            console.error("Anonymous sign-in failed after sign-out:", e);
                        }
                    }
                });

                // --- Initial Sign In ---
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (e) {
                            console.error("Custom token sign-in failed, falling back to anonymous", e);
                            await signInAnonymously(auth);
                        }
                    } else {
                        // No token, sign in anonymously (for local dev)
                        await signInAnonymously(auth);
                    }
                } else {
                    // User already exists, trigger auth update
                    updateAuthUI(currentUser);
                    if (!currentUser.isAnonymous) {
                        await loadUserData(currentUser.uid);
                    }
                }
                // The onAuthStateChanged listener will handle the rest.

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                document.getElementById('auth-loading').classList.add('hidden');
                document.getElementById('auth-status').innerHTML = `<span class="text-sm text-red-500">Auth Error</span>`;
            }
        }
        
        // --- 6. START THE APP ---
        // Load default inspiration section on page load
        updateInspirationSection(null);
        // Initialize Firebase
        initializeFirebase();

    </script>
</body>
</html>