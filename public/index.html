<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Before You Go - AI Travel Planner</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Lexend:wght@600;700;800&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- For parsing Gemini's Markdown responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Firebase SDKs (Compat version for simple script tag import) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <!-- Brand Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-primary': '#14B8A6',
                        'brand-primary-dark': '#0F766E',
                        'brand-primary-light': '#A7F3D0',
                        'brand-accent': '#F97316',
                        'brand-accent-hover': '#EA580C',
                        'brand-dark': '#1F2937',
                        'brand-light': '#F9FAFB',
                    },
                    fontFamily: {
                        'heading': ['Lexend', 'sans-serif'],
                        'sans': ['Inter', 'sans-serif'],
                    },
                    borderRadius: { '4xl': '2rem' },
                    keyframes: {
                        fadeInUp: {
                          '0%': { opacity: '0', transform: 'translateY(20px)' },
                          '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        fadeOutDown: {
                          '0%': { opacity: '1', transform: 'translateY(0)' },
                          '100%': { opacity: '0', transform: 'translateY(20px)' },
                        }
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                        'fade-out-down': 'fadeOutDown 0.5s ease-out forwards'
                    }
                }
            }
        }
    </script>
    <!-- Custom Styles -->
    <style>
        .gradient-text {
            background-image: linear-gradient(to right, #14B8A6, #F97316);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .btn-gradient {
            background: linear-gradient(to right, #F97316, #EA580C);
            transition: all 0.5s;
            background-size: 200% auto
        }
        .btn-gradient:hover {
            background-position: right center
        }
        .hero-background {
            background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.4)), url('https://images.pexels.com/photos/3278215/pexels-photo-3278215.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
            background-size: cover;
            background-position: center
        }
        .overlap-section { margin-top: -80px; }
        .textured-section { background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23F3F4F6' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); }
        .card-hover { transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; }
        .card-hover:hover { transform: translateY(-8px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }
        .modal { display: none; }
        .modal.is-open { display: flex; }
        .modal-content { animation: fadeInUp 0.5s ease-out forwards; }
        .prose h2 { margin-top: 2em; margin-bottom: 1em; font-family: 'Lexend', sans-serif; font-weight: 700; color: #1F2937; }
        .prose h3 { margin-top: 1.5em; margin-bottom: 0.5em; font-family: 'Lexend', sans-serif; font-weight: 600; color: #1F2937; }
        .prose p, .prose li { color: #4B5563; line-height: 1.75; }
        .prose a { color: #14B8A6; }
        .itinerary-day { border-left: 3px solid #14B8A6; padding-left: 1.5rem; margin-top: 1.5rem; }
        .trip-details { max-height: 0; overflow: hidden; transition: max-height 0.7s ease-in-out; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 24px; height: 24px; border-radius: 50%; border-left-color: #14B8A6; animation: spin 1s ease infinite; }
        .inspiration-grid-loading .spinner { width: 48px; height: 48px; border-width: 6px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Styling for generated markdown content */
        .gemini-content h3 { font-family: 'Lexend', sans-serif; font-size: 1.25rem; font-weight: 600; color: #1F2937; margin-top: 1.5em; }
        .gemini-content p { color: #4B5563; }
        .gemini-content ul { list-style-position: inside; }
        .gemini-content li { margin-bottom: 0.5em; }
        /* Auth tab styles */
        .auth-tab { cursor: pointer; padding-bottom: 0.5rem; border-bottom: 4px solid transparent; }
        .auth-tab.active { border-bottom-color: #14B8A6; color: #14B8A6; font-weight: 600; }
    </style>
</head>
<body class="bg-brand-light text-brand-dark font-sans">
    
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-sm shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#" class="text-2xl font-heading font-bold text-brand-primary flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                Before You Go
            </a>
            <nav class="hidden md:flex items-center space-x-8 font-medium">
                <a href="#features" class="text-gray-600 hover:text-brand-primary transition duration-300">Features</a>
                <a href="#how-it-works" class="text-gray-600 hover:text-brand-primary transition duration-300">Process</a>
                <a href="#inspiration" class="text-gray-600 hover:text-brand-primary transition duration-300">Inspiration</a>
                <div id="auth-container" class="flex items-center gap-4">
                    <button data-modal-trigger="login-modal" id="login-btn" class="text-gray-600 hover:text-brand-primary transition duration-300 font-medium">Login / Sign Up</button>
                    <span id="user-profile" class="hidden text-brand-primary font-medium"></span>
                    <button id="logout-btn" class="hidden bg-gray-200 text-gray-700 px-4 py-1.5 rounded-full font-semibold hover:bg-gray-300 transition-all duration-300 text-sm">Logout</button>
                </div>
                <button data-modal-trigger="quiz-modal" class="bg-brand-accent text-white px-6 py-2.5 rounded-full font-semibold hover:bg-brand-accent-hover transition-all duration-300 shadow-md transform hover:scale-105">Find Your Trip</button>
            </nav>
            <button id="mobile-menu-btn" class="md:hidden text-gray-600"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg></button>
        </div>
        <div id="mobile-menu" class="hidden md:hidden px-6 pb-4">
             <a href="#features" class="block py-2 text-gray-600 hover:text-brand-primary">Features</a>
             <a href="#how-it-works" class="block py-2 text-gray-600 hover:text-brand-primary">Process</a>
             <a href="#inspiration" class="block py-2 text-gray-600 hover:text-brand-primary">Inspiration</a>
             <button data-modal-trigger="login-modal" id="mobile-login-btn" class="block w-full text-center mt-2 bg-gray-700 text-white px-4 py-2 rounded-full font-semibold hover:bg-black">Login / Sign Up</button>
             <button data-modal-trigger="quiz-modal" class="block w-full text-center mt-2 bg-brand-accent text-white px-4 py-2 rounded-full font-semibold hover:bg-brand-accent-hover">Find Your Trip</button>
        </div>
    </header>

    <main>
        <!-- Sections of the landing page -->
        <section class="hero-background text-white min-h-[60vh] flex items-center">
            <div class="container mx-auto px-6 text-center">
                <h1 class="font-heading text-4xl md:text-6xl font-extrabold leading-tight mb-4">Your Journey, Perfectly Imagined.</h1>
                <p class="text-lg md:text-xl text-gray-200 max-w-3xl mx-auto mb-8">Unleash your inner explorer. We use AI to translate your personality into unforgettable travel experiences.</p>
                <div>
                    <button data-modal-trigger="quiz-modal" class="btn-gradient text-white px-8 py-4 rounded-full text-lg font-bold transition-all duration-500 shadow-lg transform hover:scale-105">Discover Your Travel DNA</button>
                </div>
            </div>
        </section>

        <!-- How it Works Section -->
        <section id="how-it-works" class="py-24 overlap-section">
            <div class="container mx-auto px-6">
                <div class="bg-white shadow-xl rounded-4xl p-8 md:p-16">
                    <div class="text-center mb-16">
                        <h2 class="font-heading text-4xl font-bold text-brand-dark">Crafting Your <span class="gradient-text">Unforgettable Journey</span></h2>
                        <p class="text-lg text-gray-600 mt-4">A simple, inspiring process to design the trip of your dreams.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                       <!-- Step 1 -->
                        <button data-modal-trigger="quiz-modal" class="group flex flex-col items-center card-hover bg-gray-50 p-8 rounded-3xl text-left">
                            <div class="h-20 w-20 flex items-center justify-center mb-6"><svg class="h-16 w-16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" stroke="#14B8A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 14h.01M12 18h.01M16 14h.01M16 18h.01" stroke="#F97316" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                            <h3 class="font-heading text-2xl font-semibold text-brand-dark mb-3">1. Reveal Your Persona</h3>
                            <p class="text-gray-600">Our psychology-backed quiz translates your unique traits into a clear Travel DNA profile.</p>
                        </button>
                        <!-- Step 2 -->
                        <button data-modal-trigger="explore-modal" class="group flex flex-col items-center card-hover bg-gray-50 p-8 rounded-3xl text-left">
                            <div class="h-20 w-20 flex items-center justify-center mb-6"><svg class="h-16 w-16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" stroke="#14B8A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="11" r="3" stroke="#F97316" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                            <h3 class="font-heading text-2xl font-semibold text-brand-dark mb-3">2. Explore Possibilities</h3>
                            <p class="text-gray-600">Our AI predicts destinations you'll love, uncovering hidden gems and authentic experiences.</p>
                        </button>
                        <!-- Step 3 -->
                        <button data-modal-trigger="journey-modal" class="group flex flex-col items-center card-hover bg-gray-50 p-8 rounded-3xl text-left">
                            <div class="h-20 w-20 flex items-center justify-center mb-6"><svg class="h-16 w-16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 18h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" stroke="#14B8A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="8" r="1" fill="#F97316"/></svg></div>
                            <h3 class="font-heading text-2xl font-semibold text-brand-dark mb-3">3. Journey Seamlessly</h3>
                            <p class="text-gray-600">Receive a live itinerary that adapts to your mood and the world around you, in real time.</p>
                        </button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Other sections like Features, Inspiration, CTA -->
        <section id="features" class="py-24 bg-white">
            <div class="container mx-auto px-6">
                <div class="text-center mb-16">
                    <h2 class="font-heading text-4xl font-bold text-brand-dark">A Smarter Way to <span class="gradient-text">Explore</span></h2>
                    <p class="text-lg text-gray-600 mt-4">Every detail, personalized for you.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                     <!-- Feature Cards -->
                    <div class="bg-brand-light p-8 rounded-2xl card-hover">
                        <h3 class="font-heading text-xl font-bold text-brand-dark mb-2">AI Predictive Recommendations ✨</h3>
                        <p class="text-gray-600">Our engine uses live web data to suggest destinations you’re destined to love.</p>
                    </div>
                    <div class="bg-brand-light p-8 rounded-2xl card-hover">
                        <h3 class="font-heading text-xl font-bold text-brand-dark mb-2">User Profile Module ✨</h3>
                        <p class="text-gray-600">Save your travel persona and preferences to your personal account for a seamless experience.</p>
                    </div>
                    <div class="bg-brand-light p-8 rounded-2xl card-hover">
                        <h3 class="font-heading text-xl font-bold text-brand-dark mb-2">Social Sync Planning</h3>
                        <p class="text-gray-600">Plan group trips without the headache. Our AI merges multiple personalities into one perfect plan.</p>
                    </div>
                    <div class="bg-brand-light p-8 rounded-2xl card-hover">
                        <h3 class="font-heading text-xl font-bold text-brand-dark mb-2">Hidden Gems Engine ✨</h3>
                        <p class="text-gray-600">Discover authentic, lesser-known experiences using live web data.</p>
                    </div>
                    <div class="bg-brand-light p-8 rounded-2xl card-hover">
                        <h3 class="font-heading text-xl font-bold text-brand-dark mb-2">Dynamic Live Itinerary ✨</h3>
                        <p class="text-gray-600">Your plans adapt in real-time to weather, delays, or spontaneous opportunities.</p>
                    </div>
                    <div class="bg-brand-light p-8 rounded-2xl card-hover">
                        <h3 class="font-heading text-xl font-bold text-brand-dark mb-2">AI Travel Buddy ✨</h3>
                        <p class="text-gray-600">A conversational assistant that uses live data to provide tips and guidance.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="inspiration" class="py-24 textured-section">
            <div class="container mx-auto px-6">
                 <div class="text-center mb-16">
                    <h2 class="font-heading text-4xl font-bold text-gray-800">Find Your <span class="gradient-text">Inspiration</span></h2>
                    <p id="inspiration-subtitle" class="text-lg text-gray-600 mt-4">First, login and take the quiz to reveal your travel persona and unlock personalized suggestions!</p>
                </div>
                <div id="inspiration-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Default State: A mix of personas -->
                    <div class="relative rounded-2xl shadow-lg overflow-hidden h-96 group card-hover">
                        <img src="https://images.pexels.com/photos/1562/italian-landscape-mountains-nature.jpg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" alt="Mountain landscape for explorers">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent flex items-end p-6">
                            <h3 class="text-white text-2xl font-heading font-bold">The Explorer</h3>
                        </div>
                    </div>
                    <div class="relative rounded-2xl shadow-lg overflow-hidden h-96 group card-hover">
                        <img src="https://images.pexels.com/photos/1450360/pexels-photo-1450360.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" alt="Serene beach for soul seekers">
                         <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent flex items-end p-6">
                            <h3 class="text-white text-2xl font-heading font-bold">The Soul Seeker</h3>
                        </div>
                    </div>
                    <div class="relative rounded-2xl shadow-lg overflow-hidden h-96 group card-hover">
                        <img src="https://images.pexels.com/photos/210307/pexels-photo-210307.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" alt="Cultural market for story collectors">
                         <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent flex items-end p-6">
                            <h3 class="text-white text-2xl font-heading font-bold">The Story Collector</h3>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="bg-brand-dark">
            <div class="container mx-auto px-6 py-20 text-center">
                <h2 class="font-heading text-4xl font-bold text-white mb-4">Ready for a New Way to Travel?</h2>
                <p class="text-gray-300 max-w-2xl mx-auto mb-8">Let's build a journey that feels like it was made just for you. Because it was.</p>
                <div>
                    <button data-modal-trigger="quiz-modal" class="btn-gradient text-white px-8 py-4 rounded-full text-lg font-bold transition-all duration-500 shadow-lg transform hover:scale-105">Get Started For Free</button>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer id="about" class="bg-gray-800 text-white">
        <div class="container mx-auto px-6 py-12">
            <div class="grid md:grid-cols-3 gap-8 text-center md:text-left">
                <!-- Footer content with links for modals -->
                <div>
                    <h3 class="font-heading text-lg font-bold">Before You Go</h3>
                    <p class="text-gray-400 mt-2">AI-Powered Travel, Personalized for You.</p>
                </div>
                <div>
                    <h3 class="font-heading text-lg font-bold">Links</h3>
                    <ul class="mt-2 space-y-2">
                        <li><a href="#features" class="text-gray-400 hover:text-white">Features</a></li>
                        <li><a href="#how-it-works" class="text-gray-400 hover:text-white">Process</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-heading text-lg font-bold">Legal</h3>
                    <ul class="mt-2 space-y-2">
                        <li><button data-modal-trigger="privacy-modal" class="text-gray-400 hover:text-white">Privacy Policy</button></li>
                        <li><button data-modal-trigger="terms-modal" class="text-gray-400 hover:text-white">Terms of Service</button></li>
                    </ul>
                </div>
            </div>
            <div class="text-center text-gray-400 mt-12 border-t border-gray-700 pt-8">
                <p>&copy; 2025 Before You Go. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Modals (Initially Hidden) -->

    <!-- Login Modal -->
    <div id="login-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white p-8 md:p-12 rounded-4xl shadow-xl w-full max-w-md">
            <button class="modal-close absolute top-4 right-4 text-gray-500 hover:text-black text-2xl">&times;</button>
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex space-x-8">
                    <button id="login-tab-btn" class="auth-tab active" data-tab="login-tab">Login</button>
                    <button id="signup-tab-btn" class="auth-tab" data-tab="signup-tab">Sign Up</button>
                </nav>
            </div>

            <!-- Login Form -->
            <div id="login-tab" class="auth-tab-content">
                <h2 class="font-heading text-3xl font-bold text-brand-dark text-center">Welcome Back</h2>
                <form id="login-form" class="mt-8 space-y-6">
                    <div>
                        <label for="login-email" class="text-sm font-medium text-gray-700">Email</label>
                        <input id="login-email" name="email" type="email" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-brand-primary focus:border-brand-primary">
                    </div>
                    <div>
                        <label for="login-password" class="text-sm font-medium text-gray-700">Password</label>
                        <input id="login-password" name="password" type="password" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-brand-primary focus:border-brand-primary">
                    </div>
                    <div id="login-error" class="text-red-600 text-sm"></div>
                    <button type="submit" class="w-full btn-gradient text-white font-bold py-3 px-4 rounded-full flex items-center justify-center gap-2">Login</button>
                </form>
            </div>

            <!-- Sign Up Form -->
            <div id="signup-tab" class="auth-tab-content hidden">
                <h2 class="font-heading text-3xl font-bold text-brand-dark text-center">Create Your Account</h2>
                <form id="signup-form" class="mt-8 space-y-6">
                    <div>
                        <label for="signup-name" class="text-sm font-medium text-gray-700">Name</label>
                        <input id="signup-name" name="name" type="text" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-brand-primary focus;border-brand-primary">
                    </div>
                    <div>
                        <label for="signup-email" class="text-sm font-medium text-gray-700">Email</label>
                        <input id="signup-email" name="email" type="email" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-brand-primary focus;border-brand-primary">
                    </div>
                    <div>
                        <label for="signup-password" class="text-sm font-medium text-gray-700">Password (min. 6 characters)</label>
                        <input id="signup-password" name="password" type="password" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-brand-primary focus;border-brand-primary">
                    </div>
                    <div id="signup-error" class="text-red-600 text-sm"></div>
                    <button type="submit" class="w-full btn-gradient text-white font-bold py-3 px-4 rounded-full flex items-center justify-center gap-2">Create Account</button>
                </form>
            </div>
        </div>
    </div>

    <div id="quiz-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50 animate-fade-in-up">
        <div class="modal-content bg-white p-8 md:p-12 rounded-4xl shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <!-- Modal Content (Quiz) will be injected here by JavaScript -->
        </div>
    </div>
    <div id="explore-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white p-8 md:p-12 rounded-4xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto relative">
            <button class="modal-close absolute top-4 right-4 text-gray-500 hover:text-black text-2xl">&times;</button>
            <div class="prose max-w-none">
                <h2 class="font-heading text-3xl font-bold text-brand-dark text-center">How Our AI Finds Your Perfect Trip</h2>
                <p class="text-center text-lg">After creating your Travel DNA, our AI sifts through thousands of destinations, reviews, and hidden gems to find experiences that match your unique profile. Here's a glimpse of what you might see:</p>
                <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6 not-prose">
                    <div class="border rounded-2xl p-4 text-center">
                        <img src="https://images.pexels.com/photos/1684151/pexels-photo-1684151.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2" class="rounded-xl aspect-square object-cover" alt="Adventure destination">
                        <h3 class="font-heading text-xl font-bold mt-4">For The Thrill-Chaser</h3>
                        <p class="text-sm">We've found a 98% match with whitewater rafting in Costa Rica.</p>
                    </div>
                    <div class="border rounded-2xl p-4 text-center">
                        <img src="https://images.pexels.com/photos/210307/pexels-photo-210307.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2" class="rounded-xl aspect-square object-cover" alt="Cultural destination">
                        <h3 class="font-heading text-xl font-bold mt-4">For The Story-Collector</h3>
                        <p class="text-sm">You'd love exploring the ancient markets of Marrakesh.</p>
                    </div>
                    <div class="border rounded-2xl p-4 text-center">
                        <img src="https://images.pexels.com/photos/1450360/pexels-photo-1450360.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2" class="rounded-xl aspect-square object-cover" alt="Relaxing destination">
                        <h3 class="font-heading text-xl font-bold mt-4">For The Soul-Seeker</h3>
                        <p class="text-sm">A 95% match for a wellness retreat in the Swiss Alps.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="journey-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white p-8 md:p-12 rounded-4xl shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto relative flex flex-col">
            <button class="modal-close absolute top-4 right-4 text-gray-500 hover:text-black text-2xl">&times;</button>
             <div class="prose max-w-none text-center mb-4">
                <h2 class="font-heading text-3xl font-bold text-brand-dark">AI Travel Buddy ✨</h2>
                <p>Ask your AI Buddy anything about your potential destinations!</p>
            </div>
            <div id="ai-buddy-chat-window" class="flex-grow border rounded-2xl p-4 overflow-y-auto bg-gray-50 flex flex-col space-y-4">
                <!-- Chat messages will appear here -->
                <div class="p-3 rounded-lg bg-brand-primary-light text-brand-primary-dark self-start max-w-md">Hello! I'm your AI Travel Buddy. I can use Google Search to answer live questions. Ask me something like "What's the weather in Rome next week?" or "Find me a budget-friendly hotel near the Eiffel Tower."</div>
            </div>
            <form id="ai-buddy-form" class="mt-4 flex gap-4">
                <input type="text" id="ai-buddy-input" placeholder="Ask about weather, hotels..." class="w-full border-gray-300 rounded-full focus:ring-brand-primary focus:border-brand-primary" required>
                <button type="submit" class="btn-gradient text-white px-6 py-2.5 rounded-full font-semibold flex-shrink-0">Send</button>
            </form>
        </div>
    </div>
    <div id="privacy-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white p-8 md:p-12 rounded-4xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto relative">
            <button class="modal-close absolute top-4 right-4 text-gray-500 hover:text-black">&times;</button>
            <div class="prose lg:prose-lg max-w-none">
                <h1 class="font-heading text-4xl font-bold text-brand-dark">Privacy Policy</h1>
                <p>This Privacy Policy describes Our policies and procedures on the collection, use and disclosure of Your information when You use the Service and tells You about Your privacy rights and how the law protects You. We use Your Personal data to provide and improve the Service. By using the Service, You agree to the collection and use of information in accordance with this Privacy Policy.</p>
                <h2>Interpretation and Definitions</h2>
                <p>The words of which the initial letter is capitalized have meanings defined under the following conditions. The following definitions shall have the same meaning regardless of whether they appear in singular or in plural.</p>
                <h2>Collecting and Using Your Personal Data</h2>
                <p>While using Our Service, We may ask You to provide Us with certain personally identifiable information that can be used to contact or identify You. Personally identifiable information may include, but is not limited to: Email address, First name and last name, Usage Data.</p>
            </div>
        </div>
    </div>
    <div id="terms-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white p-8 md:p-12 rounded-4xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto relative">
             <button class="modal-close absolute top-4 right-4 text-gray-500 hover:text-black">&times;</button>
             <div class="prose lg:prose-lg max-w-none">
                <h1 class="font-heading text-4xl font-bold text-brand-dark">Terms of Service</h1>
                <p>Please read these terms and conditions carefully before using Our Service. By accessing or using the Service you agree to be bound by these Terms and Conditions. If you disagree with any part of the terms then you may not access the Service.</p>
                <h2>Acknowledgment</h2>
                <p>These are the Terms and Conditions governing the use of this Service and the agreement that operates between You and the Company. These Terms and Conditions set out the rights and obligations of all users regarding the use of the Service.</p>
                <h2>Intellectual Property</h2>
                <p>The Service and its original content (excluding Content provided by You or other users), features and functionality are and will remain the exclusive property of the Company and its licensors. The Service is protected by copyright, trademark, and other laws of both the Country and foreign countries.</p>
            </div>
        </div>
    </div>
    <div id="trip-planner-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white p-8 md:p-12 rounded-4xl shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <!-- Trip Planner Quiz / Results will be injected here -->
        </div>
    </div>

    <script type="module" src="./config/api-keys.js"></script>
    <script type="module" src="./utils/fetch.js"></script>
    <script type="module" src="./utils/cache.js"></script>
    <script type="module" src="./app.js"></script>

    <script>
        // --- 0. FIREBASE & GLOBAL STATE ---
        let db, auth;
        let currentUserId = null;
        
        const userState = {
            name: null,
            persona: null,
            tripPreferences: {
                categoryTag: null,
                budget: null,
                distance: null,
                duration: null
            },
            lastGeneratedDestinations: [],
            tempBooking: { selectedFlight: null, selectedHotel: null }
        };

        // Your actual Firebase config, as requested
        const firebaseConfig = {
          apiKey: "AIzaSyBlb9Ye7elbpj19Y7TrHOq5eNS_02rK-44",
          authDomain: "before-you-go-10236.firebaseapp.com",
          projectId: "before-you-go-10236",
          storageBucket: "before-you-go-10236.firebasestorage.app",
          messagingSenderId: "746797011005",
          appId: "1:746797011005:web:5cd09abe929b708d0eda54",
          measurementId: "G-PKLHME3VJD"
        };
        
        const appId = "before-you-go-10236"; // Using your actual Project ID

        // Initialize Firebase
        try {
            if (firebase.apps.length === 0) {
                firebase.initializeApp(firebaseConfig);
            }
            auth = firebase.auth();
            db = firebase.firestore();
            firebase.firestore().setLogLevel('debug');
            console.log("Firebase Initialized Successfully with your project config.");
        } catch (e) {
            console.error("Error initializing Firebase:", e);
        }

        // --- 1. AUTHENTICATION LOGIC ---
        
        async function handleSignUp(e) {
            e.preventDefault();
            console.log("Attempting to SIGN UP"); // Debug log
            const signupError = document.getElementById('signup-error');
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            signupError.textContent = '';
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                // Now save the extra data to Firestore
                await saveUserProfile(user.uid, { name: name, email: email, persona: null });
                userState.name = name; // Update local state
                closeModal(document.getElementById('login-modal'));
                
                // ** NEW SEAMLESS ONBOARDING FLOW **
                const quizModal = document.getElementById('quiz-modal');
                openModal(quizModal);
                loadPersonaQuiz(quizModal);
                
            } catch (error) {
                console.error("Error signing up:", error);
                signupError.textContent = error.message;
            }
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            console.log("Attempting to LOGIN"); // Debug log
            const loginError = document.getElementById('login-error');
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            loginError.textContent = '';
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                closeModal(document.getElementById('login-modal'));
            } catch (error) {
                console.error("Error logging in:", error);
                loginError.textContent = error.message;
            }
        }

        function handleLogout() {
            auth.signOut();
        }

        function updateUIForLoggedInUser(profileData) {
            document.getElementById('login-btn').classList.add('hidden');
            const userProfile = document.getElementById('user-profile');
            userProfile.classList.remove('hidden');
            userProfile.textContent = `Hi, ${profileData.name || 'User'}`;
            document.getElementById('logout-btn').classList.remove('hidden');
            document.getElementById('mobile-login-btn').classList.add('hidden');
        }

        function updateUIForLoggedOutUser() {
            document.getElementById('login-btn').classList.remove('hidden');
            document.getElementById('user-profile').classList.add('hidden');
            document.getElementById('logout-btn').classList.add('hidden');
            document.getElementById('mobile-login-btn').classList.remove('hidden');
        }

        // --- 2. FIRESTORE DATABASE LOGIC ---
        async function loadUserProfile(userId) {
            if (!db || !userId) return;
            const userDocRef = db.collection('artifacts').doc(appId).collection('users').doc(userId);
            
            try {
                const doc = await userDocRef.get();
                if (doc.exists) {
                    const profileData = doc.data();
                    userState.persona = profileData.persona;
                    userState.name = profileData.name;
                    console.log("Loaded profile from Firestore:", profileData);
                    updateUIForLoggedInUser(profileData);
                    if (userState.persona) {
                        // ** NEW FLOW FOR RETURNING USER **
                        document.getElementById('inspiration').scrollIntoView({ behavior: 'smooth' });
                        loadDynamicInspirations(); // Personalize page on load
                    } else {
                        renderDefaultInspirations();
                    }
                } else {
                    console.log("No user profile found, this might be a fresh sign-up.");
                    const newName = auth.currentUser.displayName || userState.name || "New User";
                    if(auth.currentUser.email) {
                        await saveUserProfile(userId, { name: newName, email: auth.currentUser.email });
                    }
                    updateUIForLoggedInUser({ name: newName });
                    renderDefaultInspirations();
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                renderDefaultInspirations();
            }
        }

        async function saveUserProfile(userId, dataToSave) {
            if (!db || !userId) {
                console.log("No user ID, cannot save profile.");
                return;
            }
            const userDocRef = db.collection('artifacts').doc(appId).collection('users').doc(userId);
            try {
                await userDocRef.set(dataToSave, { merge: true });
                console.log("Saved profile data to Firestore:", dataToSave);
            } catch (error) {
                console.error("Error saving user data:", error);
            }
        }

        // --- 3. MODAL & UI LOGIC ---
        function initializeAppEventListeners() {
            console.log("Initializing event listeners...");
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
            }

            const triggers = document.querySelectorAll('[data-modal-trigger]');
            console.log(`Found ${triggers.length} modal triggers.`);
            triggers.forEach(trigger => {
                trigger.addEventListener('click', (e) => {
                    const modalId = e.currentTarget.getAttribute('data-modal-trigger');
                    console.log(`Modal trigger clicked for: ${modalId}`);
                    
                    // Check for auth before opening quiz
                    if ((modalId === 'quiz-modal' || modalId === 'trip-planner-modal') && !currentUserId) {
                        e.stopPropagation(); // Stop this event
                        openModal(document.getElementById('login-modal'));
                        return;
                    }

                    const modal = document.getElementById(modalId);
                    if (modal) {
                        openModal(modal);
                        if (modalId === 'quiz-modal') loadPersonaQuiz(modal);
                        if (modalId === 'journey-modal') setupAIBuddy();
                    }
                });
            });
            
            document.addEventListener('click', e => {
                if (e.target.matches('.modal') || e.target.matches('.modal-close')) {
                    closeModal(e.target.closest('.modal'));
                }
                if (e.target.id === 'logout-btn') {
                    handleLogout();
                }
            });
            
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('signup-form').addEventListener('submit', handleSignUp);
            
            document.getElementById('login-tab-btn').addEventListener('click', () => switchAuthTab('login'));
            document.getElementById('signup-tab-btn').addEventListener('click', () => switchAuthTab('signup'));
        }
        
        function switchAuthTab(tab) {
            if (tab === 'login') {
                document.getElementById('login-tab').classList.remove('hidden');
                document.getElementById('signup-tab').classList.add('hidden');
                document.getElementById('login-tab-btn').classList.add('active');
                document.getElementById('signup-tab-btn').classList.remove('active');
            } else {
                document.getElementById('login-tab').classList.add('hidden');
                document.getElementById('signup-tab').classList.remove('hidden');
                document.getElementById('login-tab-btn').classList.remove('active');
                document.getElementById('signup-tab-btn').classList.add('active');
            }
        }

        function openModal(modal) {
            document.body.style.overflow = 'hidden';
            modal.classList.add('is-open');
        }

        function closeModal(modal) {
            if (modal) {
                modal.classList.remove('is-open');
                document.body.style.overflow = 'auto';
            }
            // Clear any error messages
            const loginError = document.getElementById('login-error');
            const signupError = document.getElementById('signup-error');
            if (loginError) loginError.textContent = '';
            if (signupError) signupError.textContent = '';
        }

        // --- 4. DYNAMIC INSPIRATION SECTION ---
        
        const inspirationSchema = {
          "type": "ARRAY",
          "items": {
            "type": "OBJECT",
            "properties": {
              "name": { "type": "STRING" },
              "category_tag": { "type": "STRING" },
              "image_url": { "type": "STRING" }
            },
            "required": ["name", "category_tag", "image_url"]
          }
        };
        
        async function loadDynamicInspirations() {
            if (!userState.persona) {
                renderDefaultInspirations();
                return;
            }
            const inspirationSubtitle = document.getElementById('inspiration-subtitle');
            const inspirationGrid = document.getElementById('inspiration-grid');
            inspirationSubtitle.textContent = `Asking our AI to find inspiration for a(n) ${userState.persona}...`;
            inspirationGrid.innerHTML = `<div class="inspiration-grid-loading col-span-1 md:col-span-3 text-center p-16">
                <div class="spinner mx-auto"></div>
                <p class="text-lg text-gray-600 mt-4">Generating personalized themes...</p>
            </div>`;
            
            const systemPrompt = "You are a creative travel expert. Your job is to find 6 inspiring and diverse travel themes for the user based on their persona. You MUST return your answer as a valid JSON array matching the provided schema. For image_url, find a real, high-quality, relevant image URL from Pexels or Unsplash.";
            const prompt = `A user has the travel persona of a '${userState.persona}'. Use Google Search to find 6 inspiring and diverse travel themes or styles they would love. Examples include "Patagonian Glacial Treks", "Amazon River Eco-Lodge", "Tuscan Culinary Tour", "Kyoto Temple Hopping", "Bali Wellness Retreat", "Swiss Alps Paragliding".

                For each of the 6 themes, provide:
                1.  "name": The inspiring theme name (e.g., "Tuscan Culinary Tour").
                2.  "category_tag": A simple 2-3 word tag for this theme (e.g., "tuscany food wine", "kyoto historic temples"). This tag will be used in a future prompt.
                3.  "image_url": A real, high-quality image URL from Pexels or Unsplash that matches the theme.
            `;
            
            const config = { responseMimeType: "application/json", responseSchema: inspirationSchema };
            const tools = [{ "google_search": {} }];
            
            const result = await callGemini(prompt, systemPrompt, tools, config);
            
            if (result.error || !result.content || result.content.length === 0) {
                inspirationSubtitle.textContent = "Could not load AI suggestions. Please try again.";
                renderDefaultInspirations(); // Fallback to default
            } else {
                renderDynamicInspirations(result.content);
            }
        }
        
        function renderDynamicInspirations(categories) {
            const inspirationGrid = document.getElementById('inspiration-grid');
            const inspirationSubtitle = document.getElementById('inspiration-subtitle');
            inspirationSubtitle.textContent = `Based on your "${personaQuizResults[userState.persona].persona}" persona, here are some trip styles you might love. Select one to plan your trip!`;
            inspirationGrid.innerHTML = ''; // Clear loading
            inspirationGrid.classList.remove('lg:grid-cols-4', 'md:grid-cols-2');
            inspirationGrid.classList.add('lg:grid-cols-3', 'md:grid-cols-3'); // Adjust grid for 6 items

            categories.forEach(cat => {
                inspirationGrid.innerHTML += `
                    <button data-category-tag="${cat.category_tag}" class="inspiration-card relative rounded-2xl shadow-lg overflow-hidden h-96 group card-hover text-left">
                        <img src="${cat.image_url}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" alt="${cat.name}" onerror="this.onerror=null;this.src='https://placehold.co/800x600/E0E0E0/000000?text=Image+Not+Available';">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent flex items-end p-6">
                            <h3 class="text-white text-2xl font-heading font-bold">${cat.name}</h3>
                        </div>
                    </button>
                `;
            });

            // Add event listeners to the new cards
            document.querySelectorAll('.inspiration-card').forEach(card => {
                card.addEventListener('click', () => {
                    userState.tripPreferences.categoryTag = card.getAttribute('data-category-tag');
                    const modal = document.getElementById('trip-planner-modal');
                    openModal(modal);
                    loadTripPlannerQuiz(modal);
                });
            });
        }
        
        function renderDefaultInspirations() {
            const inspirationGrid = document.getElementById('inspiration-grid');
            const inspirationSubtitle = document.getElementById('inspiration-subtitle');
            inspirationSubtitle.textContent = `First, login and take the quiz to reveal your travel persona and unlock personalized suggestions!`;
            inspirationGrid.innerHTML = `
                <div class="relative rounded-2xl shadow-lg overflow-hidden h-96 group card-hover">
                    <img src="https://images.pexels.com/photos/1562/italian-landscape-mountains-nature.jpg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" alt="Mountain landscape for explorers">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent flex items-end p-6">
                        <h3 class="text-white text-2xl font-heading font-bold">The Explorer</h3>
                    </div>
                </div>
                <div class="relative rounded-2xl shadow-lg overflow-hidden h-96 group card-hover">
                    <img src="https://images.pexels.com/photos/1450360/pexels-photo-1450360.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" alt="Serene beach for soul seekers">
                     <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent flex items-end p-6">
                        <h3 class="text-white text-2xl font-heading font-bold">The Soul Seeker</h3>
                    </div>
                </div>
                <div class="relative rounded-2xl shadow-lg overflow-hidden h-96 group card-hover">
                    <img src="https://images.pexels.com/photos/210307/pexels-photo-210307.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" alt="Cultural market for story collectors">
                     <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent flex items-end p-6">
                        <h3 class="text-white text-2xl font-heading font-bold">The Story Collector</h3>
                    </div>
                </div>
            `;
            inspirationGrid.classList.remove('lg:grid-cols-4', 'md:grid-cols-2');
            inspirationGrid.classList.add('lg:grid-cols-3', 'md:grid-cols-3');
        }

        // --- 5. PERSONA QUIZ LOGIC ---
        const personaQuizQuestions = [
            { question: "A week off just opened up. Your first thought is:", options: [ { text: "Find a hidden cabin in the mountains.", value: "explorer" }, { text: "Finally, time to visit that famous museum.", value: "story-collector" }, { text: "Book a flight somewhere warm, now!", value: "soul-seeker" }, { text: "Check for last-minute adventure deals.", value: "thrill-chaser" } ] },
            { question: "The ideal pace for a vacation day is:", options: [ { text: "Packed from sunrise to sunset with activities.", value: "thrill-chaser" }, { text: "A loose plan with plenty of room for spontaneity.", value: "explorer" }, { text: "One or two main cultural sights, with lots of cafe breaks.", value: "story-collector" }, { text: "Having zero obligations is the whole point.", value: "soul-seeker" } ] },
            { question: "When you hear 'local cuisine', you think:", options: [ { text: " Michelin-starred restaurants with a famous chef.", value: "story-collector" }, { text: "Busy street food stalls everyone is talking about.", value: "explorer" }, { text: "Fresh, healthy food at a beachfront cafe.", value: "soul-seeker" }, { text: "Quick, high-energy food to fuel my activities.", value: "thrill-chaser" } ] },
            { question: "Your preferred travel companion is:", options: [ { text: "A group of friends who are up for anything.", value: "thrill-chaser" }, { text: "My partner, for a shared experience.", value: "soul-seeker" }, { text: "Just myself and a map.", value: "explorer" }, { text: "My family or a friend who loves history.", value: "story-collector" } ] },
            { question: "The perfect souvenir is:", options: [ { text: "A piece of art from a local gallery.", value: "story-collector" }, { text: "Just the memories and photos.", value: "thrill-chaser" }, { text: "An interesting rock or shell from a remote place.", value: "explorer" }, { text: "A handmade bracelet that supports local artisans.", value: "soul-seeker" } ] },
            { question: "A 'great view' means:", options: [ { text: "Looking down from the top of a mountain I just climbed.", value: "thrill-chaser" }, { text: "A panoramic city skyline from a rooftop bar.", value: "story-collector" }, { text: "An endless, empty desert or forest.", value: "explorer" }, { text: "The ocean from my private balcony.", value: "soul-seeker" } ] },
            { question: "How much of your trip do you document on social media?", options: [ { text: "I post stories all day to share the experience live.", value: "thrill-chaser" }, { text: "A curated post at the end of each day.", value: "story-collector" }, { text: "Maybe one or two photos if I remember.", value: "explorer" }, { text: "My phone is off most of the time.", value: "soul-seeker" } ] },
            { question: "What does 'luxury' mean to you on a trip?", options: [ { text: "Having a private guide and exclusive access.", value: "story-collector" }, { text: "Time and silence.", value: "soul-seeker" }, { text: "Top-of-the-line gear for my adventures.", value: "thrill-chaser" }, { text: "The freedom to have no fixed address.", value: "explorer" } ] },
            { question: "You're lost in a new city. You:", options: [ { text: "Embrace it. This is where the adventure begins.", value: "explorer" }, { text: "Ask a local shopkeeper for directions and a story.", value: "story-collector" }, { text: "Use it as an opportunity to find a quiet park and relax.", value: "soul-seeker" }, { text: "See it as a race to find my way back.", value: "thrill-chaser" } ] },
            { question: "The most important part of your accommodation is:", options: [ { text: "Proximity to nature trails or adventure spots.", value: "thrill-chaser" }, { text: "A central location in a historic district.", value: "story-collector" }, { text: "Complete isolation and privacy.", value: "explorer" }, { text: "A comfortable bed and a peaceful atmosphere.", value: "soul-seeker" } ] },
            { question: "What kind of museum would you choose?", options: [ { text: "A modern art museum with challenging exhibits.", value: "story-collector" }, { text: "An outdoor museum or historical reenactment.", value: "explorer" }, { text: "A small, quirky museum about a local legend.", value: "story-collector" }, { text: "I'd rather be outside than in a museum.", value: "thrill-chaser" } ] },
             { question: "Your ideal evening on vacation ends with:", options: [ { text: "Stargazing far from city lights.", value: "explorer" }, { text: "A quiet glass of wine and reflection.", value: "soul-seeker" }, { text: "Sharing stories with new friends at a bonfire.", value: "thrill-chaser" }, { text: "Seeing a play or a live music performance.", value: "story-collector" } ] },
            { question: "Which travel movie character are you?", options: [ { text: "Indiana Jones, searching for ancient artifacts.", value: "explorer" }, { text: "Elizabeth Gilbert in 'Eat Pray Love', on a journey of self-discovery.", value: "soul-seeker" }, { text: "James Bond, on a glamorous and action-packed mission.", value: "thrill-chaser" }, { text: "The narrator in 'Amélie', finding magic in everyday city life.", value: "story-collector" } ] },
            { question: "The best travel photos are:", options: [ { text: "Candid shots of people and daily life.", value: "story-collector" }, { text: "Epic, wide-angle landscapes with no people.", value: "explorer" }, { text: "Action shots of an activity.", value: "thrill-chaser" }, { text: "Peaceful sunrises or sunsets.", value: "soul-seeker" } ] },
            { question: "After a trip, you feel most fulfilled by:", options: [ { text: "The new skills or knowledge you acquired.", value: "story-collector" }, { text: "The sense of peace and rejuvenation.", value: "soul-seeker" }, { text: "The stories of the challenges you overcame.", value: "thrill-chaser" }, { text: "Knowing you saw a place few others have seen.", value: "explorer" } ] }
        ];
        
        const personaQuizResults = {
            'explorer': { persona: "The Explorer", title: "Your DNA is set for discovery!", description: "You're driven by curiosity and a desire to get off the beaten path. You crave authenticity and aren't afraid of a little unpredictability. Now, let's find your next great adventure below!" },
            'story-collector': { persona: "The Story Collector", title: "You're a cultural connoisseur!", description: "You travel to learn, to taste, and to immerse yourself in the rich tapestry of human history and creativity. Your perfect trip is filled with stories. Let's find your next chapter below!" },
            'soul-seeker': { persona: "The Soul Seeker", title: "You travel to reconnect!", description: "For you, a journey is a chance to recharge, reflect, and find tranquility. Comfort, beauty, and peace are your priorities. Let's find your sanctuary below!" },
            'thrill-chaser': { persona: "The Thrill Chaser", title: "You're an adrenaline junkie!", description: "You see the world as a playground and travel as a chance to push your limits. Your ideal trip gets your heart pumping. Let's find your next epic challenge below!" }
        };

        function loadPersonaQuiz(modal) {
            const container = modal.querySelector('.modal-content');
            let currentQuestionIndex = 0;
            const userAnswers = {};
            
            // **FIXED**: Use event delegation
            // We only attach *one* listener to the container, which never gets destroyed.
            // This ensures buttons always work after re-rendering.
            const quizClickListener = (e) => {
                const targetOption = e.target.closest('.quiz-option');
                if (targetOption) {
                    userAnswers[currentQuestionIndex] = parseInt(targetOption.getAttribute('data-option-index'));
                    render();
                    return;
                }

                if (e.target.closest('#next-btn')) {
                    handleNext();
                    return;
                }
                
                if (e.target.closest('#prev-btn')) {
                    if(currentQuestionIndex > 0) { 
                        currentQuestionIndex--; 
                        render(); 
                    }
                    return;
                }
            };
            
            // Remove old listener if it exists, then add the new one
            container.removeEventListener('click', quizClickListener);
            container.addEventListener('click', quizClickListener);


            function render() {
                const questionData = personaQuizQuestions[currentQuestionIndex];
                let optionsHTML = '';
                questionData.options.forEach((option, i) => {
                    const isSelected = userAnswers[currentQuestionIndex] === i;
                    optionsHTML += `<div data-option-index="${i}" class="quiz-option cursor-pointer border-2 ${isSelected ? 'border-brand-primary bg-brand-primary-light text-brand-primary-dark' : 'border-gray-200'} rounded-2xl p-4 mt-4 font-medium hover:border-brand-primary">${option.text}</div>`;
                });

                container.innerHTML = `
                    <button class="modal-close absolute top-4 right-4 text-gray-500 hover:text-black text-2xl">&times;</button>
                    <div id="quiz-container">
                        <div class="mb-8">
                            <span id="progress-text" class="text-sm font-medium text-brand-primary">Question ${currentQuestionIndex + 1} of ${personaQuizQuestions.length}</span>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2"><div id="progress-bar" class="bg-brand-primary h-2.5 rounded-full" style="width: ${((currentQuestionIndex + 1) / personaQuizQuestions.length) * 100}%"></div></div>
                        </div>
                        <h2 class="font-heading text-2xl md:text-3xl font-bold text-brand-dark">${questionData.question}</h2>
                        <div class="mt-6">${optionsHTML}</div>
                        <div id="quiz-error" class="text-red-600 text-center font-medium mt-4"></div>
                    </div>
                    <div class="mt-10 flex justify-between items-center">
                        <button id="prev-btn" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-full font-semibold hover:bg-gray-300 ${currentQuestionIndex === 0 ? 'disabled:opacity-50' : ''}" ${currentQuestionIndex === 0 ? 'disabled' : ''}>Previous</button>
                        <button id="next-btn" class="bg-brand-accent text-white px-8 py-3 rounded-full font-bold hover:bg-brand-accent-hover shadow-md">${currentQuestionIndex === personaQuizQuestions.length - 1 ? 'Reveal My Persona!' : 'Next Question'}</button>
                    </div>
                `;
            }

            async function handleNext() {
                if(userAnswers[currentQuestionIndex] === undefined) {
                    const errorEl = container.querySelector('#quiz-error');
                    if (errorEl) errorEl.textContent = "Please select an option to continue.";
                    return; 
                }

                if (currentQuestionIndex < personaQuizQuestions.length - 1) {
                    currentQuestionIndex++;
                    render();
                } else {
                    const persona = calculatePersona();
                    userState.persona = persona;
                    await saveUserProfile(currentUserId, { persona: persona }); // Save to Firebase
                    const resultData = personaQuizResults[persona];
                    renderResults(resultData, container);
                }
            }

            function calculatePersona() {
                const vote = { 'explorer': 0, 'story-collector': 0, 'soul-seeker': 0, 'thrill-chaser': 0 };
                for(let i = 0; i < personaQuizQuestions.length; i++) {
                    const answerIndex = userAnswers[i];
                    if(answerIndex !== undefined) {
                        const personaValue = personaQuizQuestions[i].options[answerIndex].value;
                        vote[personaValue]++;
                    }
                }
                let maxVotes = 0;
                let finalPersona = 'explorer';
                for (const persona in vote) {
                    if (vote[persona] > maxVotes) {
                        maxVotes = vote[persona];
                        finalPersona = persona;
                    }
                }
                return finalPersona;
            }
            
            function renderResults(resultData, container) {
                // This function used to have a delay, now it's instant
                const quizModal = document.getElementById('quiz-modal');
                closeModal(quizModal);
                loadDynamicInspirations(); // Load new AI inspirations
                document.getElementById('inspiration').scrollIntoView({ behavior: 'smooth' });
            }
            
            render();
        }

        // --- 6. TRIP PLANNER QUIZ & DESTINATION LOGIC ---
        const tripPlannerQuestions = [
            { id: 'distance', question: 'How far are you looking to go?', options: [ {text: 'Stay Domestic', value: 'domestic'}, {text: 'Short-Haul (Nearby Countries)', value: 'short-haul'}, {text: 'Long-Haul (Across the Globe)', value: 'long-haul'}] },
            { id: 'duration', question: 'How long is your trip?', options: [ {text: 'A Weekend Getaway (2-4 days)', value: 'weekend'}, {text: 'About a Week (5-10 days)', value: 'week'}, {text: 'A Long Expedition (10+ days)', value: 'expedition'}] },
            { id: 'budget', question: 'What is your travel budget style?', options: [ {text: 'Budget-Friendly (Hostels, street food)', value: 'budget'}, {text: 'Mid-Range (Comfortable hotels, mix of dining)', value: 'mid-range'}, {text: 'Luxury (High-end resorts, fine dining)', value: 'luxury'}] }
        ];

        function loadTripPlannerQuiz(modal) {
            const container = modal.querySelector('.modal-content');
            let currentQuestionIndex = 0;
            
            // Clear old preferences
            userState.tripPreferences.budget = null;
            userState.tripPreferences.distance = null;
            userState.tripPreferences.duration = null;
            
            // **FIXED**: Use event delegation
            const tripPlannerClickListener = async (e) => {
                const targetOption = e.target.closest('.quiz-option');
                if (targetOption) {
                    const value = targetOption.getAttribute('data-value');
                    const questionId = tripPlannerQuestions[currentQuestionIndex].id;
                    userState.tripPreferences[questionId] = value;
                    
                    if (currentQuestionIndex < tripPlannerQuestions.length - 1) {
                        currentQuestionIndex++;
                        render();
                    } else {
                        render(); // Re-render to show selection
                    }
                    return;
                }
                
                if (e.target.closest('#generate-trip-btn')) {
                    if (currentQuestionIndex < tripPlannerQuestions.length - 1) {
                         currentQuestionIndex++;
                         render();
                    } else if (userState.tripPreferences.budget && userState.tripPreferences.distance && userState.tripPreferences.duration) {
                        const startEl = document.getElementById('trip-start-date');
                        const endEl = document.getElementById('trip-end-date');
                        const travelersEl = document.getElementById('trip-travelers');
                        userState.tripPreferences.startDate = startEl?.value || '';
                        userState.tripPreferences.endDate = endEl?.value || '';
                        userState.tripPreferences.travelers = parseInt(travelersEl?.value || '1', 10);
                        // This is the new flow
                        showLoadingState(container);
                        let destinations = await fetchAIDestinations();
                        if (window.__enhanceDestinationsWithLiveData) {
                            try {
                                destinations = await window.__enhanceDestinationsWithLiveData(destinations, { origin: 'NYC', dates: { start: userState.tripPreferences.startDate, end: userState.tripPreferences.endDate }, travelers: userState.tripPreferences.travelers });
                            } catch (e) {}
                        }
                        renderTripResults(destinations, modal);
                    }
                    return;
                }
            };
            
            container.removeEventListener('click', tripPlannerClickListener);
            container.addEventListener('click', tripPlannerClickListener);

            
            function render() {
                const questionData = tripPlannerQuestions[currentQuestionIndex];
                 let optionsHTML = '';
                questionData.options.forEach((option, i) => {
                    const isSelected = userState.tripPreferences[questionData.id] === option.value;
                    optionsHTML += `<div data-value="${option.value}" class="quiz-option cursor-pointer border-2 ${isSelected ? 'border-brand-primary bg-brand-primary-light text-brand-primary-dark' : 'border-gray-200'} rounded-2xl p-4 mt-4 font-medium hover:border-brand-primary">${option.text}</div>`;
                });

                const extraInputs = currentQuestionIndex === tripPlannerQuestions.length - 1 ? `
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-600">Start Date</label>
                            <input type="date" id="trip-start-date" class="mt-1 w-full border rounded-xl px-3 py-2">
                        </div>
                        <div>
                            <label class="text-sm text-gray-600">End Date</label>
                            <input type="date" id="trip-end-date" class="mt-1 w-full border rounded-xl px-3 py-2">
                        </div>
                    </div>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-600">Accommodation</label>
                            <select id="trip-accommodation" class="mt-1 w-full border rounded-xl px-3 py-2">
                                <option value="hostel">Hostels</option>
                                <option value="hotel">Hotels</option>
                                <option value="resort">Resorts</option>
                                <option value="airbnb">Airbnb</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-gray-600">Travelers</label>
                            <select id="trip-travelers" class="mt-1 w-full border rounded-xl px-3 py-2">
                                <option value="1">Solo</option>
                                <option value="2">Couple</option>
                                <option value="3">Family</option>
                                <option value="4">Group</option>
                            </select>
                        </div>
                    </div>
                ` : '';

                container.innerHTML = `
                    <button class="modal-close absolute top-4 right-4 text-gray-500 hover:text-black text-2xl">&times;</button>
                    <div id="trip-planner-container">
                        <div class="mb-8 text-center">
                            <h2 class="font-heading text-3xl font-bold text-brand-dark">Plan Your Trip</h2>
                            <p class="text-gray-600">A few more details to find your perfect destination.</p>
                        </div>
                        <h3 class="font-heading text-xl font-bold text-brand-dark mt-6">${questionData.question}</h3>
                        <div>${optionsHTML}</div>
                        ${extraInputs}
                    </div>
                    <div class="mt-10 flex justify-end">
                        <button id="generate-trip-btn" class="bg-brand-accent text-white px-8 py-3 rounded-full font-bold hover:bg-brand-accent-hover shadow-md">${currentQuestionIndex === tripPlannerQuestions.length - 1 ? 'Find Destinations!' : 'Next'}</button>
                    </div>
                `;
            }
            render();
        }

        function showLoadingState(container) {
             container.innerHTML = `
                <div class="text-center animate-fade-in-up p-8">
                    <div class="spinner mx-auto" style="width: 48px; height: 48px; border-width: 6px;"></div>
                    <h2 class="font-heading text-3xl font-bold text-brand-dark mt-8">Finding Your Perfect Trip...</h2>
                    <p class="text-lg text-gray-600 mt-4">Our AI is searching the web for live data to match your unique profile. This might take a moment!</p>
                </div>
            `;
        }

        function renderTripResults(destinations, modal) {
            userState.lastGeneratedDestinations = destinations;
            const container = modal.querySelector('.modal-content');
            let resultsHTML = '';

            if (destinations && destinations.length > 0) {
                 destinations.forEach((dest, index) => {
                    resultsHTML += `
                        <div class="border bg-gray-50 rounded-2xl p-6 mt-6">
                             <div class="flex justify-between items-center">
                                <h3 class="font-heading text-2xl font-bold text-brand-dark">${dest.name}</h3>
                                <button data-details-target="${index}" class="view-details-btn text-brand-primary font-bold">View Details</button>
                             </div>
                             <div id="details-${index}" class="trip-details mt-4">
                                <img src="${dest.image_url}" class="rounded-xl aspect-video object-cover w-full" alt="${dest.name}" onerror="this.onerror=null;this.src='https://placehold.co/800x450/E0E0E0/000000?text=Image+Not+Available';">
                                <div id="itinerary-container-${index}" class="mt-4">
                                    <p class="text-gray-600 mt-4">${dest.description}</p>
                                    <div class="gemini-content">${marked.parse(dest.itinerary)}</div>
                                </div>
                                ${Array.isArray(dest.flights) && dest.flights.length ? `
                                <div class="mt-4">
                                    <h4 class="font-semibold mb-2">Flight Options</h4>
                                    <div class="space-y-2">
                                        ${dest.flights.map((f,i)=>`
                                            <div class=\\"p-3 border rounded-xl flex items-center justify-between\\">
                                                <div>
                                                    <div class=\\"font-medium\\">$${f.price} ${f.currency || ''}</div>
                                                    <div class=\\"text-sm text-gray-600\\">${(f.itineraries?.[0]?.segments?.[0]?.from || '')} → ${(f.itineraries?.[0]?.segments?.slice(-1)[0]?.to || '')} · ${f.itineraries?.[0]?.duration || ''}</div>
                                                </div>
                                                <button data-flight='${JSON.stringify({ idx:index, option:i })}' class=\\"select-flight-btn bg-gray-800 text-white px-3 py-1.5 rounded-full text-sm\\">Select Flight</button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>` : ''}
                                ${Array.isArray(dest.hotels) && dest.hotels.length ? `
                                <div class="mt-4">
                                    <h4 class="font-semibold mb-2">Hotel Options</h4>
                                    <div class="space-y-2">
                                        ${dest.hotels.map((h,i)=>`
                                            <div class=\\"p-3 border rounded-xl flex items-center justify-between\\">
                                                <div>
                                                    <div class=\\"font-medium\\">${h.name}</div>
                                                    <div class=\\"text-sm text-gray-600\\">$${h.pricePerNight || ''} ${h.currency || ''} / night · ⭐ ${h.rating || '-'} </div>
                                                </div>
                                                <button data-hotel='${JSON.stringify({ idx:index, option:i })}' class=\\"select-hotel-btn bg-gray-800 text-white px-3 py-1.5 rounded-full text-sm\\">Select Hotel</button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>` : ''}
                                <button data-dest-name="${dest.name}" class="find-gems-btn mt-4 w-full bg-brand-accent text-white font-bold py-3 px-4 rounded-full flex items-center justify-center gap-2">
                                    ✨ Suggest Hidden Gems
                                </button>
                                <div class="mt-6 flex gap-4">
                                    <button data-dest-name="${dest.name}" class="book-flights-btn w-full bg-gray-800 text-white font-bold py-2 px-4 rounded-full hover:bg-black transition-all">Book Flights</button>
                                    <button data-dest-name="${dest.name}" class="book-hotels-btn w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-full hover:bg-gray-300 transition-all">Book Hotels</button>
                                </div>
                             </div>
                        </div>
                    `;
                 });
            } else {
                resultsHTML = `<p class="text-center text-gray-600 mt-8">No exact matches found for your specific criteria, but our AI is always learning! Try different options to see more possibilities.</p>`;
            }

            container.innerHTML = `
                <button class="modal-close absolute top-4 right-4 text-gray-500 hover:text-black text-2xl">&times;</button>
                <div class="text-center animate-fade-in-up">
                    <p class="font-semibold text-brand-primary">YOUR CURATED DESTINATIONS</p>
                    <h2 class="font-heading text-4xl font-bold text-brand-dark mt-2">Here Are Your Matches</h2>
                    <div id="results-container" class="my-8 text-left max-w-none">${resultsHTML}</div>
                    <div id="booking-summary" class="mx-auto max-w-2xl text-left bg-white border rounded-2xl p-4 hidden">
                        <h3 class="font-heading text-2xl font-bold">Booking Summary</h3>
                        <div class="mt-2 text-gray-700" id="summary-lines"></div>
                        <div class="mt-4 flex justify-end gap-3">
                            <button id="confirm-booking-btn" class="bg-brand-accent text-white px-6 py-2.5 rounded-full font-semibold disabled:opacity-50" disabled>Confirm Booking</button>
                        </div>
                    </div>
                    <button class="modal-close mt-8 bg-brand-accent text-white px-8 py-3 rounded-full font-bold hover:bg-brand-accent-hover">Start Over</button>
                </div>
            `;
            
            // Re-attach event listeners for the new dynamic content
            container.querySelectorAll('.view-details-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const targetId = e.currentTarget.getAttribute('data-details-target');
                    const detailsDiv = document.getElementById(`details-${targetId}`);
                    if (detailsDiv.style.maxHeight) {
                        detailsDiv.style.maxHeight = null;
                        e.currentTarget.textContent = "View Details";
                    } else {
                        detailsDiv.style.maxHeight = detailsDiv.scrollHeight + "px";
                        e.currentTarget.textContent = "Hide Details";
                    }
                });
            });

            container.querySelectorAll('.find-gems-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const destName = e.currentTarget.getAttribute('data-dest-name');
                    const container = e.currentTarget.closest('.trip-details').querySelector(`[id^="itinerary-container-"]`);
                    handleFindHiddenGems(destName, container);
                });
            });
            
            container.querySelectorAll('.book-flights-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const destName = e.currentTarget.getAttribute('data-dest-name');
                    const url = `https://www.google.com/flights?q=Flights+to+${encodeURIComponent(destName)}`;
                    window.open(url, '_blank');
                });
            });
            
            container.querySelectorAll('.book-hotels-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const destName = e.currentTarget.getAttribute('data-dest-name');
                    const url = `https://www.google.com/search?q=Hotels+in+${encodeURIComponent(destName)}`;
                    window.open(url, '_blank');
                });
            });

            // Selection handlers
            container.querySelectorAll('.select-flight-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const data = JSON.parse(e.currentTarget.getAttribute('data-flight'));
                    const dest = destinations[data.idx];
                    userState.tempBooking.selectedFlight = { destinationIndex: data.idx, optionIndex: data.option, data: dest.flights[data.option] };
                    updateBookingSummary();
                });
            });
            container.querySelectorAll('.select-hotel-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const data = JSON.parse(e.currentTarget.getAttribute('data-hotel'));
                    const dest = destinations[data.idx];
                    userState.tempBooking.selectedHotel = { destinationIndex: data.idx, optionIndex: data.option, data: dest.hotels[data.option] };
                    updateBookingSummary();
                });
            });

            const confirmBtn = container.querySelector('#confirm-booking-btn');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', async () => {
                    const { selectedFlight, selectedHotel } = userState.tempBooking;
                    if (!selectedFlight || !selectedHotel) return;
                    const dest = destinations[selectedFlight.destinationIndex];
                    const trip = buildTripRecord(dest, selectedFlight.data, selectedHotel.data);
                    await saveActiveTrip(trip);
                    alert('Booking confirmed! Your trip has been saved.');
                });
            }

            function updateBookingSummary() {
                const { selectedFlight, selectedHotel } = userState.tempBooking;
                const wrap = container.querySelector('#booking-summary');
                const lines = container.querySelector('#summary-lines');
                if (!wrap || !lines) return;
                if (!selectedFlight && !selectedHotel) { wrap.classList.add('hidden'); return; }
                wrap.classList.remove('hidden');
                const nights = computeNights(userState.tripPreferences.startDate, userState.tripPreferences.endDate);
                const hotelNight = selectedHotel?.data?.pricePerNight ? Number(selectedHotel.data.pricePerNight) : 0;
                const flightTotal = selectedFlight?.data?.price ? Number(selectedFlight.data.price) : 0;
                const hotelTotal = hotelNight * (nights || 1);
                const total = flightTotal + hotelTotal;
                lines.innerHTML = `
                    <div>Destination: <strong>${destinations[selectedFlight?.destinationIndex || selectedHotel?.destinationIndex || 0]?.name || ''}</strong></div>
                    <div>Dates: ${userState.tripPreferences.startDate || '-'} → ${userState.tripPreferences.endDate || '-'}</div>
                    <div>Flight: ${flightTotal ? `$${flightTotal.toFixed(2)}` : '-'}</div>
                    <div>Hotel: ${hotelNight ? `$${hotelNight.toFixed(2)}/night × ${nights} = $${hotelTotal.toFixed(2)}` : '-'}</div>
                    <div class="mt-2 font-bold">Total: $${total.toFixed(2)}</div>
                `;
                const btn = container.querySelector('#confirm-booking-btn');
                if (btn) btn.disabled = !(selectedFlight && selectedHotel);
            }
        }

        function computeNights(start, end) {
            if (!start || !end) return 0;
            const s = new Date(start).getTime();
            const e = new Date(end).getTime();
            const diff = Math.max(0, e - s);
            return Math.ceil(diff / (24 * 60 * 60 * 1000));
        }

        function buildTripRecord(destination, flight, hotel) {
            const nights = computeNights(userState.tripPreferences.startDate, userState.tripPreferences.endDate);
            return {
                tripId: `${Date.now()}`,
                destination: destination?.name,
                dates: { start: userState.tripPreferences.startDate, end: userState.tripPreferences.endDate, nights },
                preferences: { ...userState.tripPreferences },
                bookings: { flight, hotel },
                itinerary: [],
                pending_suggestions: []
            };
        }

        async function saveActiveTrip(trip) {
            if (!db || !currentUserId) return;
            const userDocRef = db.collection('artifacts').doc(appId).collection('users').doc(currentUserId);
            try {
                await userDocRef.set({ active_trips: firebase.firestore.FieldValue.arrayUnion(trip) }, { merge: true });
                console.log('Saved active trip');
                await postBookingInitialize(trip);
            } catch (e) {
                console.error('Failed saving trip', e);
            }
        }

        async function postBookingInitialize(trip) {
            const modal = document.getElementById('trip-planner-modal');
            const container = modal.querySelector('.modal-content');
            container.innerHTML = `
                <button class="modal-close absolute top-4 right-4 text-gray-500 hover:text-black text-2xl">&times;</button>
                <div class="animate-fade-in-up">
                    <h2 class="font-heading text-3xl font-bold text-brand-dark">Trip Dashboard</h2>
                    <p class="text-gray-600">${trip.destination} · ${trip.dates.start} → ${trip.dates.end}</p>
                    <div id="intel-widgets" class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="p-4 bg-white border rounded-2xl">
                            <h3 class="font-semibold">Weather</h3>
                            <div id="wx" class="mt-2 text-sm text-gray-500 flex items-center gap-2"><div class="spinner"></div> Loading forecast...</div>
                        </div>
                        <div class="p-4 bg-white border rounded-2xl lg:col-span-2">
                            <h3 class="font-semibold">Events</h3>
                            <div id="events" class="space-y-2 mt-2 text-sm text-gray-500 flex items-center gap-2"><div class="spinner"></div> Loading events...</div>
                        </div>
                        <div class="p-4 bg-white border rounded-2xl lg:col-span-3">
                            <h3 class="font-semibold">Activities</h3>
                            <div id="activities" class="space-y-2 mt-2 text-sm text-gray-500 flex items-center gap-2"><div class="spinner"></div> Loading activities...</div>
                        </div>
                        <div class="p-4 bg-white border rounded-2xl lg:col-span-3">
                            <h3 class="font-semibold">AI Suggestions</h3>
                            <div id="suggestions" class="space-y-2 mt-2 text-sm text-gray-500 flex items-center gap-2"><div class="spinner"></div> Analyzing suggestions...</div>
                        </div>
                    </div>
                    <div class="mt-8">
                        <h3 class="font-heading text-2xl font-bold">Itinerary</h3>
                        <div id="itinerary-root" class="mt-3"></div>
                    </div>
                </div>
            `;

            try {
                const intel = await (window.__initializeTripIntel ? window.__initializeTripIntel({
                    destination: trip.destination,
                    coords: trip.coords || null,
                    dates: trip.dates,
                    persona: userState.persona
                }) : Promise.resolve({ events: [], activities: [], forecast: [], suggestions: [] }));

                // Weather
                const wx = container.querySelector('#wx');
                if (wx && Array.isArray(intel.forecast)) {
                    wx.innerHTML = intel.forecast.map(d => `<div class=\"text-sm\">${d.date}: ${d.icon || ''} ${d.low}°/${d.high}°C</div>`).join('');
                }

                // Events
                const evDiv = container.querySelector('#events');
                if (evDiv) {
                    evDiv.innerHTML = (intel.events || []).map(ev => `<div class=\"text-sm\"><a class=\"text-brand-primary\" href=\"${ev.sourceUrl || '#'}\" target=\"_blank\">${ev.title}</a> ${ev.start ? '· '+ev.start : ''} ${ev.venue ? '· '+ev.venue : ''}</div>`).join('') || '<div class="text-sm text-gray-500">No events found.</div>';
                }

                // Activities
                const actDiv = container.querySelector('#activities');
                if (actDiv) {
                    actDiv.innerHTML = (intel.activities || []).map(a => `<div class=\"text-sm\">${a.name} ${a.rating ? '· ⭐ '+a.rating : ''} · ${a.address || ''}</div>`).join('') || '<div class="text-sm text-gray-500">No activities found.</div>';
                }

                // Suggestions
                const sugDiv = container.querySelector('#suggestions');
                if (sugDiv) {
                    sugDiv.innerHTML = (intel.suggestions || []).map((s, i) => `
                        <div class=\"p-3 border rounded-xl flex items-center justify-between\">`
                    ).join('') || '<div class="text-sm text-gray-500">No suggestions available.</div>';
                }

                // Itinerary builder
                const itinRoot = container.querySelector('#itinerary-root');
                if (itinRoot && window.__renderItinerary) {
                    window.__renderItinerary(itinRoot, { startDate: trip.dates.start, endDate: trip.dates.end, forecast: intel.forecast || [] });
                }

                // Suggestion interactions
                container.querySelectorAll('[data-accept]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const idx = parseInt(btn.getAttribute('data-accept'), 10);
                        const s = intel.suggestions[idx];
                        if (window.__addActivityToDay) {
                            window.__addActivityToDay(itinRoot, 0, s);
                        }
                        btn.closest('div').remove();
                    });
                });
                container.querySelectorAll('[data-decline]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        btn.closest('div').remove();
                    });
                });
            } catch (e) {
                console.error('Failed to initialize trip intel', e);
                const intelWrap = container.querySelector('#intel-widgets');
                if (intelWrap) {
                    const retry = document.createElement('div');
                    retry.className = "mt-4";
                    retry.innerHTML = `<button id="retry-intel" class="bg-gray-800 text-white px-4 py-2 rounded-full">Retry loading trip intel</button>`;
                    intelWrap.appendChild(retry);
                    const btn = container.querySelector('#retry-intel');
                    btn.addEventListener('click', () => postBookingInitialize(trip));
                }
            }
        }

        // --- 7. GEMINI API INTEGRATION ---
        
        const destinationSchema = {
          "type": "ARRAY",
          "items": {
            "type": "OBJECT",
            "properties": {
              "name": { "type": "STRING" },
              "image_url": { "type": "STRING" },
              "description": { "type": "STRING" },
              "itinerary": { "type": "STRING" } // Simplified to a single markdown string
            },
            "required": ["name", "image_url", "description", "itinerary"]
          }
        };

        async function callGemini(prompt, systemInstruction, tools = null, generationConfig = null) {
            const apiKey = ""; // API key will be handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };

            if (tools) {
                payload.tools = tools;
            }
            if (generationConfig) {
                payload.generationConfig = generationConfig;
            }

            try {
                // Add exponential backoff for retries
                let response;
                let delay = 1000;
                for (let i = 0; i < 5; i++) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break; // Success
                    } else if (response.status === 429 || response.status >= 500) {
                        // Rate limit or server error, wait and retry
                        console.warn(`API call failed with status ${response.status}. Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        // Other client error, don't retry
                        console.error("API Error Response:", await response.text());
                        return { error: true, content: `<p class="text-red-500">Error: The travel AI is currently unavailable. Please try again later.</p>` };
                    }
                }
                
                if (!response.ok) {
                    console.error("API Error after retries:", await response.text());
                    return { error: true, content: `<p class="text-red-500">Error: The travel AI is too busy. Please try again later.</p>` };
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    if (generationConfig?.responseMimeType === "application/json") {
                        try {
                            return { error: false, content: JSON.parse(text) }; // Return parsed JSON
                        } catch(e) {
                            console.error("Failed to parse AI JSON response:", text, e);
                            return { error: true, content: `<p class="text-red-500">The AI returned an invalid response. Please try again.</p>` };
                        }
                    } else {
                        return { error: false, content: marked.parse(text) }; // Return parsed Markdown
                    }
                } else {
                    console.error("Invalid API response structure:", result);
                    return { error: true, content: `<p class="text-red-500">Sorry, I couldn't generate a response. The AI might be busy.</p>` };
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                return { error: true, content: `<p class="text-red-500">An error occurred while contacting the travel AI. Please check your connection.</p>` };
            }
        }
        
        async function fetchAIDestinations() {
            const { persona, tripPreferences } = userState;
            const systemPrompt = "You are an expert travel agent. Your job is to find 3 real, specific destinations that perfectly match the user's profile. You MUST return your answer as a valid JSON array matching the provided schema.";
            
            const prompt = `
                A user with the travel persona of a '${persona}' is looking for a '${tripPreferences.categoryTag}' trip.
                Their preferences are:
                - Budget: '${tripPreferences.budget}'
                - Duration: '${tripPreferences.duration}'
                - Distance: '${tripPreferences.distance}'

                Please act as an expert travel agent. Use Google Search to find 3 real, specific destination ideas that are a perfect match.

                For each of the 3 destinations, provide:
                1.  "name": The destination name (e.g., "Kyoto, Japan").
                2.  "image_url": A high-quality, relevant image URL from Pexels or Unsplash.
                3.  "description": A 1-2 paragraph description of the destination and why it fits the user's persona and preferences.
                4.  "itinerary": A sample 3-day itinerary as a single Markdown string. Use headings for each day.
            `;

            const config = {
                responseMimeType: "application/json",
                responseSchema: destinationSchema
            };
            
            const tools = [{ "google_search": {} }];
            
            const result = await callGemini(prompt, systemPrompt, tools, config);

            if (result.error) {
                console.error("Failed to fetch AI destinations:", result.content);
                return []; // Return empty array on error
            }

            return result.content; // This is now a JSON array
        }

        async function handleFindHiddenGems(destinationName, container) {
            const button = container.querySelector('.find-gems-btn');
            button.innerHTML = `<div class="spinner"></div><span>Finding Gems...</span>`;
            button.disabled = true;
            
            const { persona } = userState;
            const prompt = `
                You are a local expert for '${destinationName}'. A tourist with the travel persona 
                of a '${persona}' is visiting. **Use Google Search** to find 3 unique, non-touristy 'hidden gems' 
                (like a specific cafe, a small museum, a beautiful walking path, or a local market) 
                that are currently popular or well-regarded. For each suggestion, briefly explain why it fits their persona.
                Use markdown for formatting.
            `;
            
            const tools = [{ "google_search": {} }];
            const result = await callGemini(prompt, `You are a local guide with deep knowledge of hidden gems.`, tools);
            
            const gemsContainer = document.createElement('div');
            gemsContainer.className = "gemini-content mt-4 border-t pt-4";
            gemsContainer.innerHTML = result.content;
            container.appendChild(gemsContainer);
            button.style.display = 'none'; // Hide button after use

            // Make sure the collapsible section resizes correctly
            const detailsDiv = container.closest('.trip-details');
            detailsDiv.style.maxHeight = detailsDiv.scrollHeight + "px";
        }
        
        function setupAIBuddy() {
            const form = document.getElementById('ai-buddy-form');
            const input = document.getElementById('ai-buddy-input');
            const chatWindow = document.getElementById('ai-buddy-chat-window');
            
            // This is a one-time setup, so we use a flag to prevent multiple listeners
            if (form.dataset.initialized) return;
            form.dataset.initialized = true;

            form.addEventListener('submit', async e => {
                e.preventDefault();
                const userMessage = input.value.trim();
                if (!userMessage) return;
                
                if (!currentUserId) {
                    openModal(document.getElementById('login-modal'));
                    return;
                }

                // Add user message to window
                const userBubble = document.createElement('div');
                userBubble.className = "p-3 rounded-lg bg-brand-accent text-white self-end max-w-md";
                userBubble.textContent = userMessage;
                chatWindow.appendChild(userBubble);
                input.value = '';
                chatWindow.scrollTop = chatWindow.scrollHeight;

                // Add loading indicator
                const loadingBubble = document.createElement('div');
                loadingBubble.className = "p-3 rounded-lg bg-brand-primary-light text-brand-primary-dark self-start max-w-md flex items-center";
                loadingBubble.innerHTML = `<div class="spinner mr-2"></div> Thinking...`;
                chatWindow.appendChild(loadingBubble);
                chatWindow.scrollTop = chatWindow.scrollHeight;

                const destinationContext = userState.lastGeneratedDestinations.length > 0 
                    ? `The user is interested in these destinations: ${userState.lastGeneratedDestinations.map(d => d.name).join(', ')}.`
                    : "The user has not selected a destination yet, so try to answer generally.";
                
                const systemPrompt = `You are the 'AI Travel Buddy'. Be friendly, helpful, and concise. You have access to Google Search. ${destinationContext}. When asked for live data (like weather, "what's open now", or availability), explicitly state that you are looking up live information.`;
                const tools = [{ "google_search": {} }];
                
                const result = await callGemini(userMessage, systemPrompt, tools);

                // Replace loading bubble with AI response
                loadingBubble.innerHTML = result.content;
                chatWindow.scrollTop = chatWindow.scrollHeight;
            });
        }
        
        // --- 8. INITIALIZE APP ---
        document.addEventListener('DOMContentLoaded', () => {
            // **FIX**: Initialize all event listeners *after* DOM is loaded
            initializeAppEventListeners();

            // Auth state listener is now set up *after* DOM is ready
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    console.log("User is signed in:", user.uid);
                    currentUserId = user.uid;
                    await loadUserProfile(user.uid);
                } else {
                    console.log("User is signed out.");
                    currentUserId = null;
                    userState.persona = null;
                    userState.name = null;
                    updateUIForLoggedOutUser();
                    renderDefaultInspirations(); //Reset to default
                }
            });
        });

    </script>
</body>
</html>